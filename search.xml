<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>docker muti-stage build</title>
      <link href="2019/11/04/docker-mutilpstage-build/"/>
      <url>2019/11/04/docker-mutilpstage-build/</url>
      
        <content type="html"><![CDATA[<img src="/gallery/thumbnails/multi-stage.jpg" title="mutistage_build"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>docker å¤šé˜¶æ®µæ„å»ºæ˜¯ä»<a href="https://docs.docker.com/engine/release-notes/#17050-ce" target="_blank" rel="noopener">17.05.0-ce</a>å¼€å§‹æ”¯æŒçš„ï¼Œæ‰€ä»¥ä½ è¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½é‚£ä¹ˆä½ çš„dockerç‰ˆæœ¬å¿…é¡»å¤§äºè¿™ä¸ªã€‚ä½¿ç”¨<code>muti-stage build</code>å¯ä»¥å‡å°‘æ„å»ºä¹‹åçš„é•œåƒå¤§å°ï¼Œä½¿ç”¨ä¾èµ–ç¼“å­˜ï¼Œå¯ä»¥åœ¨CI/CDçš„åœºæ™¯ä¸­ä½¿ç”¨ï¼Œé¿å…ç®¡ç†å¤šä¸ªç¼–è¯‘ç¯å¢ƒçš„å°´å°¬ï¼ˆä¸€å°æœºå™¨ä½ æ‰“ç®—è£…å¤šå°‘nodejsã€javaç‰ˆæœ¬ï¼Œæ­¤å¤–è¿˜æœ‰ç¼–è¯‘å·¥å…·npmã€yarnã€mavenã€gradleğŸ˜…ï¼‰</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CI/CD </tag>
            
            <tag> è¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>grpcä¸graphqlæœ€ä½³å®è·µ</title>
      <link href="2019/10/24/grpc-yu-graphql-zui-jia-shi-jian/"/>
      <url>2019/10/24/grpc-yu-graphql-zui-jia-shi-jian/</url>
      
        <content type="html"><![CDATA[<img src="/gallery/thumbnails/graphql_grpc.png" title="graphql_grpc"><p>æœ¬æ–‡åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ç¿»è¯‘è‡ª<a href="https://john-millikin.com/effective-grpc" target="_blank" rel="noopener">effective-grpc</a>ï¼Œå¦ä¸€éƒ¨åˆ†æ¥è‡ªäºé›†æˆgrpc graphqlå®è·µã€‚æ–‡ç« å†…å®¹éƒ½æ˜¯ç»è¿‡å®è·µï¼Œè¯·æ”¾å¿ƒé£Ÿç”¨ï¼</p><a id="more"></a><h1 id="Effective-grpc"><a href="#Effective-grpc" class="headerlink" title="Effective grpc"></a>Effective grpc</h1><h2 id="grpc"><a href="#grpc" class="headerlink" title="grpc"></a>grpc</h2><h3 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h3><p>ä½¿ç”¨<code>google.protobuf.Status</code>æ¶ˆæ¯å°†é”™è¯¯æŠ¥å‘Šç»™å®¢æˆ·ç«¯-gRPCåº“åº”é’ˆå¯¹æ‚¨çš„è¯­è¨€å¯¹è¿™ç§ç±»å‹è¿›è¡Œç‰¹æ®ŠåŒºåˆ†ï¼ˆä¾‹å¦‚ï¼Œgrpc-goå…·æœ‰<a href="https://godoc.org/google.golang.org/grpc/status" target="_blank" rel="noopener">google.golang.org/grpc/status</a>)ã€‚è¯¥æ¶ˆæ¯å¯ä»¥åŒ…å«ä»»æ„å­æ¶ˆæ¯ï¼Œå› æ­¤æœåŠ¡å™¨å¯ä»¥å‘æ‰€æœ‰å®¢æˆ·ç«¯æä¾›åŸºæœ¬é”™è¯¯æ¶ˆæ¯ï¼Œå¹¶å‘å¯ä»¥å¤„ç†è¿™äº›é”™è¯¯çš„å®¢æˆ·ç«¯æä¾›ç»“æ„åŒ–é”™è¯¯ã€‚ æœ‰å…³æ¯ä¸ªé”™è¯¯ä»£ç çš„å«ä¹‰çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒ<a href="https://github.com/googleapis/googleapis/blob/master/google/rpc/code.proto" target="_blank" rel="noopener">google/rpc/code.proto</a>ï¼›æœ‰å…³å¦‚ä½•ç¼–å†™é”™è¯¯æ¶ˆæ¯çš„è¯¦ç»†å»ºè®®ï¼Œè¯·å‚è€ƒ<a href="https://cloud.google.com/apis/design/errors" target="_blank" rel="noopener">Google Cloud Error Model</a>ã€‚</p><blockquote><p>grpc-javaä¸­ä¸º<a href="https://grpc.github.io/grpc-java/javadoc/index.html?io/grpc/Status.html" target="_blank" rel="noopener">io.grpc.Status</a></p></blockquote><h3 id="è¶…æ—¶å’Œæˆªæ­¢æ—¶é—´"><a href="#è¶…æ—¶å’Œæˆªæ­¢æ—¶é—´" class="headerlink" title="è¶…æ—¶å’Œæˆªæ­¢æ—¶é—´"></a>è¶…æ—¶å’Œæˆªæ­¢æ—¶é—´</h3><p>æœåŠ¡å™¨ç«¯å¤„ç†ç¨‹åºåº”å§‹ç»ˆä¼ æ’­æˆªæ­¢æ—¶é—´ï¼Œå®¢æˆ·å‡ ä¹åº”è¯¥æ€»æ˜¯è®¾å®šæˆªæ­¢æ—¶é—´ã€‚ä¼˜å…ˆé€‰æ‹©æˆªæ­¢æ—¶é—´è€Œä¸æ˜¯è¶…æ—¶ï¼Œå› ä¸ºåœ¨è·¨ç½‘ç»œè¾¹ç•Œå·¥ä½œæ—¶ï¼Œç»å¯¹æ—¶é—´æˆ³çš„å«ä¹‰ä¸å¦‚ç›¸å¯¹æ—¶é—´æ¨¡ç³Šã€‚ æ ¹æ®ä½ çš„å®ç°åº“ï¼Œæœ‰å¯èƒ½åœ¨service schemaä¸­å®šä¹‰é»˜è®¤è¶…æ—¶ï¼Œä¸è¦è¿™æ ·åš-schemaåˆ›å»ºè€…æ— æ³•é¢„æµ‹å“ªç§è¡Œä¸ºé€‚åˆæ‰€æœ‰å®ç°æˆ–ç”¨æˆ·ã€‚</p><h3 id="è®¿é—®åœ°å€"><a href="#è®¿é—®åœ°å€" class="headerlink" title="è®¿é—®åœ°å€"></a>è®¿é—®åœ°å€</h3><p>å§‹ç»ˆéµå¾ª<a href="https://github.com/grpc/grpc/blob/master/doc/naming.md" target="_blank" rel="noopener">gRPCåç§°è§£æ</a>æ‰€ä½¿ç”¨çš„ç±»ä¼¼URLçš„è¯­æ³•ï¼Œå°†gRPCåœ°å€è¡¨ç¤ºå¹¶å­˜å‚¨ä¸ºå®Œæ•´å­—ç¬¦ä¸²ã€‚è¯¸å¦‚<code>IP +ç«¯å£å…ƒç»„</code>ä¹‹ç±»çš„é™åˆ¶æ€§æ ¼å¼ä¼šä½¿æƒ³è¦åœ¨æ›´å¤§çš„æ¡†æ¶æˆ–é›†æˆæµ‹è¯•ä¸­è¿è¡Œæ‚¨çš„ä»£ç çš„ç”¨æˆ·çƒ¦æ¼ï¼Œè¿™äº›æµ‹è¯•å¯èƒ½å¯¹ç½‘ç»œåœ°å€æœ‰è‡ªå·±çš„æƒ³æ³•ã€‚ è®©åœ°å€è®¾ç½®åœ¨å‘½ä»¤è¡Œæ ‡å¿—æˆ–é…ç½®æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥é…ç½®å®ƒä»¬è€Œä¸å¿…ä¿®è¡¥äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å³ä½¿æ‚¨ç¡®å®éå¸¸ç¡®å®šæ•´ä¸ªä¸–ç•Œéƒ½å¸Œæœ›åœ¨ç«¯å£80ä¸Šè¿è¡ŒæœåŠ¡ï¼Œä¹Ÿè¦è¿™æ ·åšã€‚</p><h3 id="æµ"><a href="#æµ" class="headerlink" title="æµ"></a>æµ</h3><p>gRPCæ”¯æŒå•å‘å’ŒåŒå‘æ¶ˆæ¯æµï¼Œå¦‚æœè¦ä¼ è¾“çš„æ•°æ®é‡å¯èƒ½å¾ˆå¤§ï¼Œæˆ–è€…åœ¨å®Œå…¨æ¥æ”¶åˆ°è¾“å…¥ä¹‹å‰å¦ä¸€ç«¯å¯ä»¥æœ‰æ„ä¹‰åœ°å¤„ç†æ•°æ®ï¼Œè¯·ä½¿ç”¨æµã€‚ä¾‹å¦‚ï¼Œæä¾›SHA256æ–¹æ³•çš„æœåŠ¡å¯ä»¥åœ¨è¾“å…¥å—åˆ°è¾¾æ—¶å¯¹å…¶è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç„¶ååœ¨å®¢æˆ·ç«¯å…³é—­è¯·æ±‚æµæ—¶å°†æœ€ç»ˆæ‘˜è¦å‘é€å›å»ã€‚ ä¸ä¸ºæ¯ä¸ªå—å‘é€å•ç‹¬çš„RPCç›¸æ¯”ï¼Œæµä¼ è¾“æ•ˆç‡æ›´é«˜ï¼Œä½†æ¯”æ‰€æœ‰å—éƒ½ä½äºé‡å¤å­—æ®µä¸­çš„å•ä¸ªRPCæ•ˆç‡è¦ä½ã€‚æµçš„å¼€é”€å¯ä»¥é€šè¿‡ä½¿ç”¨æ‰¹å¤„ç†æ¶ˆæ¯ç±»å‹æ¥æœ€å°åŒ–ã€‚</p><pre class=" language-proto"><code class="language-proto">service Foo {    rpc MyStream(FooRequest) returns (stream MyStreamItem);}message MyStreamItem {    repeated MyStreamValue values = 1;}message MyStreamValue {    // ... fields for each logical value}</code></pre><blockquote><p>WARNINGï¼šåœ¨æŸäº›å®ç°ä¸­ï¼ˆä¾‹å¦‚grpc-goï¼‰ï¼Œæµå¥æŸ„ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå³ä½¿æ˜¯å®¢æˆ·ç«¯å­˜æ ¹ä¹Ÿä¸æ˜¯ã€‚ä¸æ¥è‡ªå¤šä¸ªçº¿ç¨‹çš„æµå¥æŸ„è¿›è¡Œäº¤äº’å¯èƒ½ä¼šå¯¼è‡´ä¸å¯é¢„æµ‹çš„è¡Œä¸ºï¼ŒåŒ…æ‹¬é™é»˜æ¶ˆæ¯æŸåã€‚</p></blockquote><h3 id="è¯·æ±‚-å“åº”ç±»å‹"><a href="#è¯·æ±‚-å“åº”ç±»å‹" class="headerlink" title="è¯·æ±‚/å“åº”ç±»å‹"></a>è¯·æ±‚/å“åº”ç±»å‹</h3><p>åœ¨ä½ çš„<code>service</code>ä¸­æ¯ä¸ªæ–¹æ³•éƒ½åº”è¯¥æœ‰è‡ªå·±ç‹¬æœ‰çš„è¯·æ±‚å’Œå“åº”æ¶ˆæ¯</p><pre class=" language-proto"><code class="language-proto">service Foo {    rpc Bar(BarRequest) returns (BarResponse);}message BarRequest  { ... }message BarResponse { ... }</code></pre><p>è¯·ä¸è¦åœ¨ä¸åŒçš„æ–¹æ³•ä¸­ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯ï¼Œé™¤éä»–ä»¬å®é™…ä¸Šæ˜¯ä½¿ç”¨ä¸åŒçš„APIå®ç°ç›¸åŒçš„æ–¹æ³•(ä¾‹å¦‚ä¸€å…ƒå’Œæµå˜ç§æ¥æ”¶åŒæ ·çš„å“åº”)ã€‚å³ä½¿è¿™ç§æƒ…å†µï¼Œå¯¹äºAPIä¹Ÿæœ‰å¯èƒ½æœ‰ä¸åŒçš„éƒ¨åˆ†ï¼Œæ­¤æ—¶è¯·æ–°å»ºå¦ä¸€ä¸ªç±»å‹ã€‚</p><pre class=" language-proto"><code class="language-proto">service Foo {    rpc Bar(BarRequest) returns (BarResponse);    rpc BarStream(BarRequest) returns (stream BarResponseStreamItem);}message BarRequest  { ... }message BarResponse { ... }message BarResponseStreamItem { ... }</code></pre><p>WARNING: è¯·ä¸è¦ä½¿ç”¨<code>google.protobuf.Empty</code>ä½œä¸ºè¯·æ±‚å’Œå“åº”ç±»å‹ï¼Œä»–çš„APIæ–‡æ¡£ä¸­çš„æè¿°<a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/empty.proto" target="_blank" rel="noopener">google/protobuf/empty.proto</a>æ˜¯ä¸€ç§åæ¨¡å¼ã€‚å¦‚æœä½ ä½¿ç”¨<code>Empty</code>ï¼Œ é‚£ä¹ˆå°†å­—æ®µæ·»åŠ åˆ°è¯·æ±‚/å“åº”ä¸­å°†ä½¿æ‰€æœ‰å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„APIå‘ç”Ÿé‡å¤§å˜åŒ–ã€‚</p><h2 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h2><h3 id="åŒ…å"><a href="#åŒ…å" class="headerlink" title="åŒ…å"></a>åŒ…å</h3><p>ä½¿ç”¨è½¯ä»¶åŒ…åç§°ã€é¡¹ç›®åç§°ã€å…¬å¸ï¼ˆå¦‚æœé€‚ç”¨ï¼‰å’Œ<a href="https://semver.org/" target="_blank" rel="noopener">è¯­ä¹‰ç‰ˆæœ¬</a>æ§åˆ¶ä¸»ç‰ˆæœ¬ã€‚ç¡®åˆ‡çš„æ ¼å¼å–å†³äºä¸ªäººå–œå¥½-æµè¡Œçš„æ ¼å¼åŒ…æ‹¬Javaä¸­ä½¿ç”¨çš„<a href="https://en.wikipedia.org/wiki/Reverse_domain_name_notation" target="_blank" rel="noopener">åå‘åŸŸåè¡¨ç¤ºæ³•</a>ï¼Œæˆ–æ ¸å¿ƒgRPCç±»å‹ä½¿ç”¨çš„<code>$COMPANY</code>.<code>$PROJECT</code></p><ul><li><code>om.mycompany.my_project.v1</code></li><li><code>com.mycompany.MyProject.v1</code></li><li><code>mycompany.my_project.v1</code><br>å°šæœªå®Œå…¨ç¨³å®šçš„APIç‰ˆæœ¬åº”å…·æœ‰v1alphaï¼Œv2beta1æˆ–v3testä¹‹ç±»çš„åç¼€ã€‚æœ‰å…³æ›´è¯¦å°½çš„æŒ‡å¯¼ï¼Œè¯·å‚è€ƒK<a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/empty.proto" target="_blank" rel="noopener">ubernetes APIç‰ˆæœ¬æ§åˆ¶ç­–ç•¥</a>ã€‚<br></li></ul><p>Protobufè½¯ä»¶åŒ…åç§°ç”¨äºç”Ÿæˆçš„ä»£ç ä¸­ï¼Œå› æ­¤è¯·é¿å…ä½¿ç”¨å†…ç½®ç±»å‹æˆ–å…³é”®å­—ï¼ˆä¾‹å¦‚returnæˆ–void)ç­‰å¸¸ç”¨çš„åç§°ã€‚è¿™å¯¹äºç”ŸæˆC ++å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºC ++ï¼ˆä»protobuf 3.6èµ·ï¼‰æ²¡æœ‰<code>FileOption</code>æ¥è¦†ç›–é»˜è®¤çš„<code>namespace</code>è®¡ç®—åç§°ã€‚</p><h3 id="import-path"><a href="#import-path" class="headerlink" title="import path"></a>import path</h3><p>å°è¯•ä»åŸå§‹æ–‡ä»¶çš„ä½ç½®æ„å»ºï¼Œä»¥ä½¿å¯¼å…¥è·¯å¾„ä¸ç¨‹åºåŒ…åç§°åŒ¹é…ï¼š<code>mycompany.my_project.v1</code>ä¸­çš„ç±»å‹åº”ä¸<code>import "mycompany/my_project/v1/some_file.proto"</code>ä¸€èµ·å¯¼å…¥ã€‚ Protobufå·¥å…·é“¾ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯ç¡®å®å¯ä»¥å¸®åŠ©æˆ‘ä»¬è®°ä½è¾“å…¥çš„å†…å®¹ã€‚</p><h3 id="Next-Number-æ³¨é‡Š"><a href="#Next-Number-æ³¨é‡Š" class="headerlink" title="Next-Number æ³¨é‡Š"></a>Next-Number æ³¨é‡Š</h3><p>åœ¨å¤§å‹protobufæ¶ˆæ¯ä¸­ï¼Œå¼„æ¸…æ¥šåº”è¯¥ä¸ºæ–°å­—æ®µä½¿ç”¨å“ªä¸ªå­—æ®µç¼–å·å¯èƒ½ä¼šå¾ˆçƒ¦äººã€‚ä¸ºäº†ç®€åŒ–å°†æ¥çš„ç¼–è¾‘è€…çš„å·¥ä½œï¼Œè¯·åœ¨æ¶ˆæ¯å’Œæšä¸¾çš„æœ«å°¾æ·»åŠ æ³¨é‡Š</p><pre class=" language-proto"><code class="language-proto">message MyMessage {    // ... lots of fields here ...    // NEXT: 42}</code></pre><h3 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h3><p>æšä¸¾ä½œç”¨åŸŸéµå¾ªæ—§å¼C/C ++è§„åˆ™ï¼Œå› æ­¤å®šä¹‰çš„åç§°ä¸é™äºæšä¸¾åç§°ï¼š</p><pre><code>// symbol `FUN_LEVEL_HIGH' is of type `FunLevel'.enum FunLevel {    FUN_LEVEL_UNKNOWN = 0;    FUN_LEVEL_LOW = 1;    FUN_LEVEL_HIGH = 2;    // NEXT: 3}</code></pre><blockquote><p>æšä¸¾å€¼ä¸èƒ½é‡å¤ï¼Œå³ä½¿æ˜¯åœ¨ä¸åŒæšä¸¾ç±»å‹ä¸­ï¼Œä½ å¯èƒ½è§‰å¾—è¿™æ ·å¾ˆå˜æ€ï¼Œä½†æ˜¯äº‹å®å°±æ˜¯è¿™æ ·çš„-_-</p></blockquote><p>å¯¹äºä¹ æƒ¯äºå…·æœ‰æ›´ç°ä»£èŒƒå›´è§„åˆ™çš„è¯­è¨€çš„ç”¨æˆ·è€Œè¨€ï¼Œè¿™å¯èƒ½å¾ˆåˆ«æ‰­ã€‚æˆ‘å–œæ¬¢ç”¨æ¶ˆæ¯åŒ…è£…æšä¸¾ï¼š</p><pre><code>// symbol `FunLevel::HIGH` is of type `FunLevel::Enum`.message FunLevel {    enum Enum {        UNKNOWN = 0;        LOW = 1;        HIGH = 2;        // NEXT: 3    }}</code></pre><h3 id="å¢“ç¢‘"><a href="#å¢“ç¢‘" class="headerlink" title="å¢“ç¢‘"></a>å¢“ç¢‘</h3><p>å¦‚æœæŸä¸ªå­—æ®µå·²è¢«åˆ é™¤ï¼Œåˆ™å…¶å­—æ®µç¼–å·ä¸å¾—å†è¢«å°†æ¥çš„å­—æ®µæ·»åŠ é‡ç”¨ã€‚é€šè¿‡æ·»åŠ å¸¦æœ‰é€»è¾‘æ ‡è®°çš„å¢“ç¢‘<a href="https://developers.google.com/protocol-buffers/docs/proto3#reserved" target="_blank" rel="noopener">ä¿ç•™å­—</a>æ¥é˜²æ­¢æ„å¤–çš„å­—æ®µå·é‡ç”¨ã€‚æˆ‘æ€»æ˜¯ä¿ç•™å­—æ®µåç§°å’Œç¼–å·:</p><pre class=" language-proto"><code class="language-proto">enum FunLevel {    // removed -- too much fun    reserved "FUN_LEVEL_EXCESSIVE"; reserved 10;}message MyMessage {    reserved "crufty_old_field"; reserved 20;}</code></pre><h2 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h2><p>Protobufæ²¡æœ‰ç”¨äºAPIæ–‡æ¡£çš„å†…ç½®ç”Ÿæˆå™¨ã€‚åœ¨å¯ç”¨é€‰é¡¹ä¸­ï¼Œ<a href="https://github.com/pseudomuto/protoc-gen-doc" target="_blank" rel="noopener">protoc-gen-doc</a>ä¼¼ä¹æœ€æˆç†Ÿï¼Œè¯·æŸ¥çœ‹åœ¨<a href="https://github.com/pseudomuto/protoc-gen-doc/blob/master/README.md" target="_blank" rel="noopener">protoc-gen-doc README</a>ä¸­çš„è¯­æ³•å’Œä¾‹å­</p><h2 id="å‚æ•°éªŒè¯"><a href="#å‚æ•°éªŒè¯" class="headerlink" title="å‚æ•°éªŒè¯"></a>å‚æ•°éªŒè¯</h2><p>Protobufé™¤äº†proto2ï¼ˆå·²åœ¨proto3ä¸­åˆ é™¤ï¼‰æ‰€è¦æ±‚çš„ä¹‹å¤–ï¼Œæ²¡æœ‰å†…ç½®çš„éªŒè¯æœºåˆ¶ã€‚ envoyproxyçš„<a href="https://github.com/envoyproxy/protoc-gen-validate" target="_blank" rel="noopener">protoc-gen-validate</a>å·¥å…·æ˜¯æˆ‘æ‰€çŸ¥é“çš„æœ€å¥½çš„è§£å†³æ–¹æ¡ˆ</p><h3 id="å¯é€‰çš„è‡ªå®šä¹‰ç±»å‹"><a href="#å¯é€‰çš„è‡ªå®šä¹‰ç±»å‹" class="headerlink" title="å¯é€‰çš„è‡ªå®šä¹‰ç±»å‹"></a>å¯é€‰çš„è‡ªå®šä¹‰ç±»å‹</h3><p>åœ¨proto3ä¸­ï¼Œåˆ é™¤äº†å°†æ ‡é‡å­—æ®µï¼ˆint32ï¼Œå­—ç¬¦ä¸²ç­‰ï¼‰æ ‡è®°ä¸ºå¯é€‰çš„åŠŸèƒ½ã€‚æ ‡é‡å­—æ®µç°åœ¨å§‹ç»ˆå­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–è®¾ç½®ï¼Œå°†ä¸ºé»˜è®¤çš„<code>é›¶å€¼</code>ã€‚å½“ä¸ºå…¶ä¸­<code>""</code>å’Œ<code>NULL</code>æ˜¯é€»è¾‘ä¸Šä¸åŒçš„å€¼çš„ç³»ç»Ÿè®¾è®¡æ¶æ„æ—¶ï¼Œè¿™å¯èƒ½ä»¤äººæ²®ä¸§ã€‚ å®˜æ–¹è§£å†³æ–¹æ³•æ˜¯ä¸€ç»„åœ¨<code>Google/protobuf/wrappers.proto</code>ä¸­å®šä¹‰çš„â€œåŒ…è£…å™¨ç±»å‹â€ï¼Œç”¨äºå®šä¹‰å•å€¼æ¶ˆæ¯ã€‚ä½ çš„æ¶æ„å¯ä»¥ä½¿ç”¨<code>google.protobuf.Int32Value</code>è€Œä¸æ˜¯<code>int32</code>æ¥è·å¾—å¯é€‰æ€§ã€‚</p><pre class=" language-proto"><code class="language-proto">import "google/protobuf/wrappers.proto";message MyMessage {    .google.protobuf.Int32Value some_field = 1;}</code></pre><p>å¦ä¸€ç§æ–¹æ³•æ˜¯å°†æ ‡é‡å­—æ®µåŒ…è£…ä¸º<a href="https://developers.google.com/protocol-buffers/docs/proto3#oneof" target="_blank" rel="noopener">oneof</a>ï¼Œè€Œæ²¡æœ‰å…¶ä»–é€‰æ‹©.å¹¶åœ¨ç”Ÿæˆçš„ä»£ç ä¸­æ·»åŠ è¾…åŠ©æ–¹æ³•ä»¥æ£€æµ‹æ˜¯å¦è®¾ç½®äº†è¯¥å­—æ®µ,æ¥è¿«ä½¿æ ‡é‡å­—æ®µå…·æœ‰å¯é€‰æ€§ã€‚</p><pre><code>message MyMessage {    oneof oneof_some_field {        int32 some_field = 1;    }}</code></pre><h1 id="graphqlä¸grpcé›†æˆ"><a href="#graphqlä¸grpcé›†æˆ" class="headerlink" title="graphqlä¸grpcé›†æˆ"></a>graphqlä¸grpcé›†æˆ</h1><p><a href="https://graphql.cn/" target="_blank" rel="noopener">grapql</a>æ˜¯ä¸€ç§ç”¨äºæŸ¥è¯¢çš„apiè¯­è¨€ï¼Œè·Ÿprotobufä¸€æ ·åŒæ ·çš„æ˜¯ä½¿ç”¨schemaæè¿°ï¼Œç±»å‹ç³»ç»Ÿéƒ½æ˜¯è‡ªå·±ç‹¬æœ‰çš„ã€‚åœ¨ä¸graphqlå’Œgrpcé›†æˆè¿‡ç¨‹æœ€å¤§é—®é¢˜å°±æ˜¯ç±»å‹é—®é¢˜ã€‚å…·ä½“è¯·æŸ¥çœ‹<a href="https://silencecorner.github.io/2019/08/18/graphql-grpc-in-java-world-1/">graphqlå’Œgrpcé›†æˆ</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> grpc </tag>
            
            <tag> graphql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>org.hibernate.LazyInitializationException</title>
      <link href="2019/08/19/org-hibernate-lazyinitializationexception-could-not-initialize-proxy-xxxx-no/"/>
      <url>2019/08/19/org-hibernate-lazyinitializationexception-could-not-initialize-proxy-xxxx-no/</url>
      
        <content type="html"><![CDATA[<img src="/gallery/thumbnails/unitOfWork.png" title="unitOfWork"><h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><p>ä½¿ç”¨reflectasmçš„MethodAccessè°ƒç”¨getæ–¹æ³•å‡ºé”™ï¼ŒæŠ¥é”™<code>org.hibernate.LazyInitializationException: could not initialize proxy [com.bd.post.model.Post#2] - no Session</code></p><a id="more"></a><h1 id="æŸ¥é”™è¿‡ç¨‹"><a href="#æŸ¥é”™è¿‡ç¨‹" class="headerlink" title="æŸ¥é”™è¿‡ç¨‹"></a>æŸ¥é”™è¿‡ç¨‹</h1><p>ä½¿ç”¨çš„ormæ¡†æ¶æ˜¯<code>spring data jpa</code>ï¼Œ<code>LazyInitializationException</code>ç¬¬ä¸€æ—¶é—´æƒ³åˆ°<code>hibernate</code>å’Œ<code>spring data jpa</code>çš„æ‡’åŠ è½½æœºåˆ¶ã€‚æˆ‘ç†è§£çš„æ‡’åŠ è½½çš„æ¦‚å¿µæ˜¯<code>åœ¨çœŸæ­£ä½¿ç”¨æ•°æ®çš„æ—¶å€™æ‰å»æ‰§è¡Œsqlè¯­å¥(é…ç½®å¤–é”®å…³è”)ï¼ŒæŸ¥è¯¢å¯¹å¤–å»ºå…³è”å¯¹è±¡</code>ï¼Œä½†æ˜¯æˆ‘çš„modelé…ç½®å¦‚ä¸‹ï¼š</p><pre><code>/** * @author &lt;a href="mailto:hilin2333@gmail.com"&gt;created by silencecorner 2019/7/10 3:28 PM&lt;/a&gt; */@NoArgsConstructor@Entity@Data@EntityListeners(AuditingEntityListener.class)@ProtoClass(PostProto.Post.class)public class Post {    @Id    @GeneratedValue(strategy = GenerationType.IDENTITY)    @ProtoField    private Integer id;    @ProtoField    private String title;    @ProtoField    private String body;    @ProtoField    private Integer authorId;    @CreatedDate    @ProtoField(nullValue = ProtobufNullValueInspectorImpl.class,converter = LocalDateTimeConverterImpl.class)    private LocalDateTime createdAt;    @LastModifiedDate    private LocalDateTime updatedAt;    public Post(String title, String body) {        this.title = title;        this.body = body;    }    public Post(String title, String body, Integer authorId) {        this.title = title;        this.body = body;        this.authorId = authorId;    }}</code></pre><p>è¿™é‡Œæˆ‘å¹¶æ²¡æœ‰é…ç½®å¤–é”®çš„å…³è”å¯¹è±¡å‘€ï¼<br><br>å…·ä½“çš„é”™è¯¯ä¿¡æ¯é‡Œé¢åˆæœ‰<code>no session</code>ï¼Œåœ¨ormæ¡†æ¶é‡Œé¢éƒ½æœ‰sessionçš„æ¦‚å¿µå¯¹åº”æ•°æ®åº“çš„sessionï¼Œåœ¨mybatisä¸­æ˜¯<code>sqlsession</code>,spring data jpaå’Œhibernateä¸­å°±å«sessionã€‚æ£€æŸ¥ä»£ç å‘ç°ä½¿ç”¨äº†<code>JpaRepositoryçš„getOne</code>æ–¹æ³•è·å–æ•°æ®</p><pre><code>  /**  * Returns a reference to the entity with the given identifier. Depending on how the JPA persistence provider is  * implemented this is very likely to always return an instance and throw an  * {@link javax.persistence.EntityNotFoundException} on first access. Some of them will reject invalid identifiers  * immediately.  *  * @param id must not be {@literal null}.  * @return a reference to the entity with the given identifier.  * @see EntityManager#getReference(Class, Object) for details on when an exception is thrown.  */  T getOne(ID id);</code></pre><p>å¤§æ¦‚çš„æ„æ€æ˜¯ï¼Œåªè¿”å›ä¸€ä¸ªå¼•ç”¨ï¼Œä¿¡æ¯çœ‹å¼‚å¸¸ä¿¡æ¯ï¼Œwhat?<br>æ‰¾åˆ°è°ƒç”¨çš„æ–¹æ³•è¯´æ˜</p><pre><code>  /**    * Get an instance, whose state may be lazily fetched.    * If the requested instance does not exist in the database,    * the &lt;code&gt;EntityNotFoundException&lt;/code&gt; is thrown when the instance     * state is first accessed. (The persistence provider runtime is     * permitted to throw the &lt;code&gt;EntityNotFoundException&lt;/code&gt; when     * &lt;code&gt;getReference&lt;/code&gt; is called.)    * The application should not expect that the instance state will    * be available upon detachment, unless it was accessed by the    * application while the entity manager was open.    * @param entityClass  entity class    * @param primaryKey  primary key    * @return the found entity instance    * @throws IllegalArgumentException if the first argument does    *         not denote an entity type or the second argument is    *         not a valid type for that entity's primary key or    *         is null    * @throws EntityNotFoundException if the entity state     *         cannot be accessed    */  public &lt;T&gt; T getReference(Class&lt;T&gt; entityClass, Object primaryKey);</code></pre><p>è¿™é‡Œç»ˆäºè¯´å•¦æ˜¯æ‡’åŠ è½½ï¼Œç„¶åå°±æ˜¯ä¸å¸Œæœ›è¿™ä¸ªå¯¹è±¡å˜æˆæ¸¸ç¦»æ€ï¼Œé™¤éentity manageræ‰“å¼€ã€‚å¥½å§ï¼è¿™é‡Œé¡ºä¾¿å›å¿†ä¸€ä¸‹hibernateå’Œjpaçš„å¯¹è±¡çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€éƒ½æ˜¯ä»<a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" target="_blank" rel="noopener">martinfowlerçš„å·¥ä½œå•å…ƒ/Unit of Work</a>æ€æƒ³å¾—æ¥çš„ã€‚è¿™äº›æ¦‚å¿µéƒ½æ˜¯éš¶å±äº<code>persistence coentext</code>ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Œæ—¢ç„¶éš¶å±ä¸€ä¸ªä¸Šä¸‹æ–‡é‚£è‚¯å®šæ˜¯æœ‰å…³ç³»çš„ã€‚å…¶ä¸­</p><ul><li>ç¬æ—¶æ€/transient <blockquote><p>æ–°newçš„ä¸€ä¸ªå°±æ˜¯è¡¨å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ç¬æ—¶æ€</p></blockquote></li><li>æŒä¹…æ€/persistent <blockquote><p>æ‰§è¡Œä¸€ä¸‹saveæ–¹æ³•ï¼Œè¿™ä¸ªå¯¹è±¡å°±å˜æˆæŒä¹…æ€</p></blockquote></li><li>æ¸¸ç¦»æ€/detachment <blockquote><p>è¿™ä¸ªä¿å­˜è¿‡çš„å¯¹è±¡ä¿®æ”¹å±æ€§ä¹‹åå°±å˜æˆäº†æ¸¸ç¦»æ€ï¼ˆps:æŒä¹…æ€ä¿®æ”¹å±æ€§éƒ½ä¼šå˜æˆæ¸¸ç¦»æ€)ã€‚å¥½äº†ï¼Œä¸Šé¢æœ‰ä¸€å¥æœ€å…³é”®çš„è¯å°±æ˜¯<code>unless it was accessed by the application while the entity manager was open</code>ã€‚å»æ‰¾ä¸€ä¸‹æˆ‘ä»¬çš„<code>EntityManager</code>æ¥å£ï¼Œå®ƒæ˜¯å®ç°äº†<code>Session</code>æ¥å£çš„ã€‚å¾ˆè‡ªç„¶çš„å°±æƒ³åˆ°äº†äº‹åŠ¡ï¼ŒæŒä¹…åŒ–æ²¡æœ‰äº‹åŠ¡æ€ä¹ˆèƒ½è¡Œï¼ˆæˆ‘å½“æ—¶å†™çš„æ—¶å€™è¿˜çœŸæ²¡æœ‰åŠ ï¼Œå“ˆå“ˆï¼ï¼‰ã€‚</p></blockquote></li></ul><p><a href="https://github.com/silencecorner/graphql-grpc-exmaple/blob/master/post-api-java/src/main/java/com/bd/post/service/PostServiceImpl.java#L67" target="_blank" rel="noopener">ä»£ç æºæ–‡ä»¶</a></p><pre><code>@Transactional@Overridepublic void updatePost(PostProto.UpdatePostRequest request, StreamObserver&lt;PostProto.Post&gt; responseObserver){  check(request);  // field_mask å¡«å……å­—æ®µ  Configuration configuration = Configuration.builder().addIgnoredFields(new FieldsIgnore().add(Post.class, "authorId", "createdAt")).build();  Post post = Converter.create(configuration).toDomain(Post.class, request);  Post newPost = postRepository.getOne(post.getId());  CopyUtils.copyProperties(post, newPost, true);  responseObserver.onNext(modelToRpc(postRepository.save(newPost)));  responseObserver.onCompleted();}</code></pre><p>é‚£ä¹ˆåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹å»ä½¿ç”¨è¿”å›<code>Optional</code>çš„<code>findById</code>ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨è¿”å›æ‡’åŠ è½½å¯¹è±¡çš„<code>getOne</code>å‘¢ï¼Ÿä»å«ä¹‰ä¸Šæ¥è®²ï¼Œ<code>getOne</code>è¡¨ç¤ºæ•°æ®ä¸€å®šå­˜åœ¨ï¼Œå¯ä»¥åœ¨udpateçš„æ—¶å€™ä½¿ç”¨ï¼Œè€Œ<code>findById</code> ä¼šç«‹åˆ»è¿”å›ç»“æœï¼Œå¯èƒ½å­˜åœ¨ä¹Ÿå¯èƒ½ä¸å­˜åœ¨ã€‚å¦å¤–ï¼Œ<code>getOne</code>å› ä¸ºæ˜¯è¿”å›çš„æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œè¿˜æ²¡æœ‰å…·ä½“æ‰§è¡Œï¼Œç»™ä¸€ç§å¼‚æ­¥çš„æ„Ÿè§‰ï¼Œå¯ä»¥åœ¨å“åº”å¼webç¨‹åºä¸­ä½¿ç”¨è¿”å›<code>CompletableFuture</code>ç­‰å°è£…å¯¹è±¡ï¼Œå½“ä¹Ÿå¾—ç¬¦åˆæ•°æ®å¿…é¡»åœ¨æ•°æ®åº“ä¸­å­˜åœ¨è¿™ä¸ªæ¡ä»¶ã€‚</p><h1 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h1><p>æ‡’åŠ è½½éœ€è¦å°†ç›¸åº”çš„ä¸œè¥¿ä¿å­˜åˆ°sessionï¼Œæˆ‘ä»¬èƒ½æ§åˆ¶å°±æ˜¯åŠ ä¸€ä¸ªäº‹åŠ¡æ³¨è§£åœ¨æ–¹æ³•ä¸Š<code>@Transactional</code>å£°æ˜è¿™ä¸ªæ–¹æ³•æ²¡æœ‰æ‰§è¡Œå®Œä¹‹å‰sessionä¸å…³é—­ã€‚å› ä¸ºä½¿ç”¨çš„spring bootï¼Œä¹Ÿå¯ä»¥åŠ ä¸€ä¸ª<b>ä¸æ¨èä½¿ç”¨</b>çš„<a href="https://vladmihalcea.com/the-hibernate-enable_lazy_load_no_trans-anti-pattern/" target="_blank" rel="noopener">é…ç½®</a>ï¼š</p><pre><code>spring.jpa.properties.hibernate.enable_lazy_load_no_trans=true</code></pre><p>æå®š</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>jdbcçš„ä¸­sesionå’Œæ•°æ®åº“çš„sesionçš„æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œsesionä¸­ä¿å­˜å½“å‰ä¼šè¯å˜é‡äº‹åŠ¡å£°æ˜ï¼åœ¨hibernateå’Œjpaä¸­è¿˜æœ‰ä¸€ä¸ª<code>persistence coentext</code>çš„æ¦‚å¿µï¼šæ¸¸ç¦»æ€ã€ç¬æ—¶æ€ã€æŒä¹…æ€ï¼Œè¿™äº›å…¶å®éƒ½æ˜¯è·Ÿsessionå¯†åˆ‡ç›¸å…³çš„ã€‚</p><hr><p>å¤šçœ‹çœ‹å­¦å­¦è¿˜æ˜¯æœ‰å¿…è¦çš„ï¼Œhave a nice day ^_^!</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> issue </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>graphqlä¸grpcé›†æˆ</title>
      <link href="2019/08/18/graphql-grpc-in-java-world-1/"/>
      <url>2019/08/18/graphql-grpc-in-java-world-1/</url>
      
        <content type="html"><![CDATA[<img src="/gallery/thumbnails/1_o9_bjlKXlMjii3G7BCNb-Q.png" title="æ¶æ„å›¾"><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>graphqlå’Œgrpcçš„protobufçš„schemaéƒ½æ˜¯ä¸€ä¸ªæè¿°æ€§æ–‡ä»¶ï¼Œåªæ˜¯åŒæ–¹çš„å…·ä½“ä½œç”¨æœ‰å·®åˆ«è€Œå·²ã€‚åœ¨Javaä¸­ä½¿ç”¨schema firstçš„<code>graphql-java-tools</code>æ— ç–‘æ˜¯graphqlåœ¨javaè¯­è¨€çš„æœ€ä½³å…¥é—¨å®è·µï¼Œé‚£ä¹ˆé—®é¢˜å°±æ¥å•¦ï¼protobufå’Œgraphqlå„è‡ªéƒ½æœ‰è‡ªå·±çš„ç±»å‹ç³»ç»Ÿï¼Œgraphqlå› ä¸ºä¼šåºåˆ—åŒ–ä¸ºjsonï¼Œé‚£ä¹ˆå°±è¦éµä»java beançš„è§„èŒƒï¼ˆåºåˆ—åŒ–æ¡†æ¶è¦æ±‚ï¼‰ï¼Œprotobufä½¿ç”¨çš„builderæ„é€ å¯¹è±¡ï¼Œæ²¡æœ‰é»˜è®¤çš„æ„é€ æ–¹æ³•ã€‚<a id="more"></a>  <br><br>æœ¬æ–‡ä»£ç ä»“åº“åœ°å€:<a href="https://github.com/silencecorner/graphql-grpc-exmaple" target="_blank" rel="noopener">https://github.com/silencecorner/graphql-grpc-exmaple</a>ï¼Œå¦‚æœäº†è§£<a href="https://github.com/graphql-java-kickstart" target="_blank" rel="noopener">graphql-java-kickstart</a>çš„ä»£ç çš„è¯ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹æºä»£ç ï¼</p><ul><li><code>graphql-api</code> nodejså®ç°çš„ç½‘å…³</li><li><code>graphql-gateway-java</code> javaå®ç°çš„ç½‘å…³</li><li><code>post-api-java</code> postæœåŠ¡ç«¯å¾®æœåŠ¡ç¨‹åº</li><li><code>protos</code> protoæºæ–‡ä»¶</li><li><code>schema</code> graphqlæ–‡ä»¶ç›®å½•</li><li><code>vue-apollo-sample</code> åŸºäºgraphqlè§„èŒƒçš„vueé¡¹ç›®<h3 id="ä¼˜åŒ–æ€è·¯"><a href="#ä¼˜åŒ–æ€è·¯" class="headerlink" title="ä¼˜åŒ–æ€è·¯"></a>ä¼˜åŒ–æ€è·¯</h3><h4 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h4>å› ä¸ºåœ¨å»å¹´å®è·µè¿‡ä¸€æ¬¡ï¼Œæ²¡æœ‰æ·±å…¥æ€è€ƒï¼Œå†™èµ·æ¥æ€»æ„Ÿè§‰æœ‰ä¸€ç‚¹åˆ«æ‰­ï¼æ‰€ä»¥æœ€å¼€å§‹æˆ‘çš„æƒ³æ³•æ˜¯æ”¹ç”¨nodejsæ¥å†™å»æ‰ç±»å‹æ£€æŸ¥ï¼Œä¹Ÿå†™è¿‡ä¸€ä¸ªåœ¨<a href="https://github.com/silencecorner/graphql-grpc-exmaple/tree/master/graphql-api" target="_blank" rel="noopener">repoçš„graphql-apiä¸­</a><h4 id="converter"><a href="#converter" class="headerlink" title="converter"></a>converter</h4>nodejså†™èµ·æ¥æŒºç®€å•çš„ï¼Œä½†æ˜¯javaæ‰æ˜¯ä¸»è¦å¼€å‘è¯­è¨€ï¼Œæ‰€ä»¥åˆæŒ‰ç…§å»å¹´çš„é‚£ä¸ªå¥—è·¯å®ç°äº†ä¸€æ¬¡ï¼ŒæŒ‰ç…§converterçš„æ€è·¯ä½¿ç”¨äº†<a href="https://github.com/silencecorner/protobuf-converter" target="_blank" rel="noopener">protobuf-converter</a>ç±»åº“,ä¼˜åŒ–äº†ä¸€ä¸‹ä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€äº›ä¸é€‚ã€‚<h4 id="jacksonåºåˆ—åŒ–æ¡†æ¶"><a href="#jacksonåºåˆ—åŒ–æ¡†æ¶" class="headerlink" title="jacksonåºåˆ—åŒ–æ¡†æ¶"></a>jacksonåºåˆ—åŒ–æ¡†æ¶</h4>ä»Šå¤©æˆ‘å°±åœ¨æƒ³èƒ½ä¸èƒ½jacksonå’Œprotobufä¹‹é—´åšæ¡¥æ¥ä¸€ä¸‹ï¼Œgoogleæœç´¢äº†æœç„¶å·²ç»æœ‰å®ç°çš„<a href="https://github.com/HubSpot/jackson-datatype-protobuf" target="_blank" rel="noopener">ç±»åº“</a>ï¼Œç»ˆäºä¸ç”¨å†å†™ä¸€éjava modelå•¦ï¼<h5 id="åˆ é™¤ä»£ç "><a href="#åˆ é™¤ä»£ç " class="headerlink" title="åˆ é™¤ä»£ç "></a>åˆ é™¤ä»£ç </h5>åˆ é™¤ä¹‹å‰çš„inputsã€types packageï¼Œæ”¹ç”¨protobufç”Ÿæˆçš„ä»£ç ï¼Œè¿™é‡Œæ¡¥æ¥è¦æ³¨å…¥<code>ProtobufModule</code>ï¼Œåˆæƒ³èƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨è¿”å›<code>ListenableFuture</code>å®ä¾‹ï¼Œé€šè¿‡æŸ¥æ‰¾èµ„æ–™å¯ä»¥å®ç°ã€‚<h5 id="æ·»åŠ GraphqlToolConfiguration-java"><a href="#æ·»åŠ GraphqlToolConfiguration-java" class="headerlink" title="æ·»åŠ GraphqlToolConfiguration.java"></a>æ·»åŠ <code>GraphqlToolConfiguration.java</code></h5><pre><code>@Configurationpublic class GraphqlToolConfiguration {  @Bean  SchemaParserOptions options(){      ObjectMapper objectMapper = Jackson2ObjectMapperBuilder.json()          .modules(new ProtobufModule(), new Jdk8Module(), new KotlinModule(), new JavaTimeModule())          .build();      return SchemaParserOptions.newOptions()          .genericWrappers(SchemaParserOptions.GenericWrapper              .withTransformer(ListenableFuture.class,0,ListenableFuturesExtra::toCompletableFuture, type -&gt; type))          .objectMapperProvider(fieldDefinition -&gt; objectMapper )          .useDefaultGenericWrappers(true)          .build();  }}</code></pre>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨protobufç”Ÿæˆçš„classã€grpcç›´æ¥è¿”å›çš„<code>ListenableFuture</code>ï¼Œå­—æ®µå¯¹åº”protobufçš„<a href="https://developers.google.com/protocol-buffers/docs/style#message-and-field-names" target="_blank" rel="noopener">JsonName</a>ï¼Œ<h5 id="schema-graphql"><a href="#schema-graphql" class="headerlink" title="schema.graphql"></a>schema.graphql</h5><pre class=" language-graphql"><code class="language-graphql">scalar DateTime</code></pre></li></ul><h1 id="ä½œè€…"><a href="#ä½œè€…" class="headerlink" title="ä½œè€…"></a>ä½œè€…</h1><p>type Author{</p><h1 id="unique-id"><a href="#unique-id" class="headerlink" title="unique id"></a>unique id</h1><p>  id: ID!</p><h1 id="åç§°"><a href="#åç§°" class="headerlink" title="åç§°"></a>åç§°</h1><p>  name: String<br>}</p><h1 id="æ·»åŠ ä½œè€…å‚æ•°"><a href="#æ·»åŠ ä½œè€…å‚æ•°" class="headerlink" title="æ·»åŠ ä½œè€…å‚æ•°"></a>æ·»åŠ ä½œè€…å‚æ•°</h1><p>input AddAuthorRequest{</p><h1 id="åå­—"><a href="#åå­—" class="headerlink" title="åå­—"></a>åå­—</h1><p>  name: String!<br>}</p><p>type Post {</p><h1 id="id"><a href="#id" class="headerlink" title="id"></a>id</h1><p>  id: ID</p><h1 id="æ ‡é¢˜"><a href="#æ ‡é¢˜" class="headerlink" title="æ ‡é¢˜"></a>æ ‡é¢˜</h1><p>  title: String</p><h1 id="å†…å®¹"><a href="#å†…å®¹" class="headerlink" title="å†…å®¹"></a>å†…å®¹</h1><p>  body: String</p><h1 id="åˆ›å»ºæ—¶é—´"><a href="#åˆ›å»ºæ—¶é—´" class="headerlink" title="åˆ›å»ºæ—¶é—´"></a>åˆ›å»ºæ—¶é—´</h1><p>  createdAt: DateTime</p><h1 id="æ–‡ç« ä½œè€…"><a href="#æ–‡ç« ä½œè€…" class="headerlink" title="æ–‡ç« ä½œè€…"></a>æ–‡ç« ä½œè€…</h1><p>  author: Author<br>}</p><h1 id="åˆ†é¡µè¿”å›ç»“æœ"><a href="#åˆ†é¡µè¿”å›ç»“æœ" class="headerlink" title="åˆ†é¡µè¿”å›ç»“æœ"></a>åˆ†é¡µè¿”å›ç»“æœ</h1><p>type Posts {</p><h1 id="æ€»æ•°"><a href="#æ€»æ•°" class="headerlink" title="æ€»æ•°"></a>æ€»æ•°</h1><p>  count: Int</p><h1 id="å½“å‰é¡µ"><a href="#å½“å‰é¡µ" class="headerlink" title="å½“å‰é¡µ"></a>å½“å‰é¡µ</h1><p>  page: Int</p><h1 id="æ¡æ•°"><a href="#æ¡æ•°" class="headerlink" title="æ¡æ•°"></a>æ¡æ•°</h1><p>  limit: Int</p><h1 id="ç»“ç‚¹"><a href="#ç»“ç‚¹" class="headerlink" title="ç»“ç‚¹"></a>ç»“ç‚¹</h1><p>  nodesList: [Post]<br>}</p><h1 id="æ·»åŠ æ–‡ç« å‚æ•°"><a href="#æ·»åŠ æ–‡ç« å‚æ•°" class="headerlink" title="æ·»åŠ æ–‡ç« å‚æ•°"></a>æ·»åŠ æ–‡ç« å‚æ•°</h1><p>input AddPostRequest {</p><h1 id="æ ‡é¢˜-1"><a href="#æ ‡é¢˜-1" class="headerlink" title="æ ‡é¢˜"></a>æ ‡é¢˜</h1><p>  title: String</p><h1 id="å†…å®¹-1"><a href="#å†…å®¹-1" class="headerlink" title="å†…å®¹"></a>å†…å®¹</h1><p>  body: String<br>}</p><h1 id="åˆ†é¡µå‚æ•°"><a href="#åˆ†é¡µå‚æ•°" class="headerlink" title="åˆ†é¡µå‚æ•°"></a>åˆ†é¡µå‚æ•°</h1><p>input ListPostRequest{<br>    # ç¬¬å‡ é¡µ<br>    page: Int!<br>    # è·å–æ¡æ•°<br>    limit: Int!</p><p>}<br>type Query {<br>  listPosts(request: ListPostRequest): Posts<br>}</p><p>type Mutation {<br>  addPost(request: AddPostRequest): Post</p><h1 id="æ–°å¢ä½œè€…"><a href="#æ–°å¢ä½œè€…" class="headerlink" title="æ–°å¢ä½œè€…"></a>æ–°å¢ä½œè€…</h1><p>  addAuthor(request: AddAuthorRequest!): Author<br>}</p><p>schema {<br>  query: Query<br>  mutation: Mutation<br>}</p><pre><code>##### Mutation.java```java@AllArgsConstructor@Componentpublic class Mutation implements GraphQLMutationResolver {    private final PostClient postClient;    private final AuthorClient authorClient;    public ListenableFuture&lt;PostProto.Post&gt; addPost(PostProto.AddPostRequest request){        return postClient.addPost(request.toBuilder().setAuthorId(1).build());    }    public ListenableFuture&lt;AuthorProto.Author&gt; addAuthor(AuthorProto.AddAuthorRequest request){          return authorClient.addAuthor(request);    }}</code></pre><h5 id="Query-java"><a href="#Query-java" class="headerlink" title="Query.java"></a>Query.java</h5><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@AllArgsConstructor</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Query</span> <span class="token keyword">implements</span> <span class="token class-name">GraphQLQueryResolver</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> PostClient postClient<span class="token punctuation">;</span>    <span class="token keyword">public</span> ListenableFuture<span class="token operator">&lt;</span>PostProto<span class="token punctuation">.</span>Posts<span class="token operator">></span> <span class="token function">listPosts</span><span class="token punctuation">(</span>PostProto<span class="token punctuation">.</span>ListPostRequest request<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> postClient<span class="token punctuation">.</span><span class="token function">listPost</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="PostResolver-java"><a href="#PostResolver-java" class="headerlink" title="PostResolver.java"></a>PostResolver.java</h5><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostResolver</span> <span class="token keyword">implements</span> <span class="token class-name">GraphQLResolver</span><span class="token operator">&lt;</span>PostProto<span class="token punctuation">.</span>Post<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> AuthorClient authorClient<span class="token punctuation">;</span>    <span class="token keyword">public</span> ListenableFuture<span class="token operator">&lt;</span>AuthorProto<span class="token punctuation">.</span>Author<span class="token operator">></span> <span class="token function">author</span><span class="token punctuation">(</span>PostProto<span class="token punctuation">.</span>Post post<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> authorClient<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getAuthorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="repeatedå­—æ®µè½¬æ¢å¤±è´¥è§£å†³"><a href="#repeatedå­—æ®µè½¬æ¢å¤±è´¥è§£å†³" class="headerlink" title="repeatedå­—æ®µè½¬æ¢å¤±è´¥è§£å†³"></a><code>repeated</code>å­—æ®µè½¬æ¢å¤±è´¥è§£å†³</h5><p>protoå®šä¹‰çš„æ˜¯<a href="https://github.com/silencecorner/graphql-grpc-exmaple/blob/master/protos/Post.proto#L26" target="_blank" rel="noopener">nodes</a>å­—æ®µï¼Œç”Ÿæˆçš„javaä»£ç çš„getæ–¹æ³•æ˜¯<code>getNodesList</code>ï¼Œæ­¤æ—¶å¯¹åº”çš„jacksonçš„jsonå­—æ®µå°±å˜æˆ<code>nodesList</code>ï¼Œæˆ‘ä»¬çš„graphqlä¸­ä½¿ç”¨æ˜¯<code>nodes</code>å­—æ®µï¼ŒæŒ‰ç…§<code>graphql-java-tools</code>çš„è§£æé¡ºåº</p><ul><li>com.bd.gateway.resolvers.post.PostsResolver.nodes(sample.PostProto$Posts)</li><li>com.bd.gateway.resolvers.post.PostsResolver.getNodes(sample.PostProto$Posts)</li><li>com.bd.gateway.resolvers.post.PostsResolver.nodes</li><li>sample.PostProto$Posts.nodes()</li><li>sample.PostProto$Posts.getNodes()</li><li>sample.PostProto$Posts.nodes</li></ul><p>åŒæ ·å¯¹<code>repeated</code>ä¿®é¥°çš„è¯·æ±‚å‚æ•°åŒæ ·ç”Ÿæ•ˆï¼Œé€šè¿‡<a href="https://github.com/silencecorner/graphql-java-tools/commit/659d342281012653126aa1d8d9962af2f348a816" target="_blank" rel="noopener">æ·»åŠ graphql-java-tools Liståç¼€åŒ¹é…</a>ï¼Œè§£å†³<code>repeated</code>å­—æ®µæ¡¥æ¥è½¬æ¢å¤±è´¥çš„é—®é¢˜</p><h5 id="PostClient-java"><a href="#PostClient-java" class="headerlink" title="PostClient.java"></a>PostClient.java</h5><pre><code>@Servicepublic class PostClient {    @GrpcClient("post-grpc-server")    private PostServiceGrpc.PostServiceFutureStub postServiceFutureStub;    public ListenableFuture&lt;PostProto.Post&gt; addPost(sample.PostProto.AddPostRequest request){        return postServiceFutureStub.addPost(request);    }    public ListenableFuture&lt;PostProto.Posts&gt; listPost(sample.PostProto.ListPostRequest request){        return postServiceFutureStub.listPosts(request);    }}</code></pre><h5 id="AuthorClient-java"><a href="#AuthorClient-java" class="headerlink" title="AuthorClient.java"></a>AuthorClient.java</h5><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorClient</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@GrpcClient</span><span class="token punctuation">(</span><span class="token string">"author-grpc-server"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> AuthorServiceGrpc<span class="token punctuation">.</span>AuthorServiceFutureStub authorServiceFutureStub<span class="token punctuation">;</span>    <span class="token keyword">public</span> ListenableFuture<span class="token operator">&lt;</span>AuthorProto<span class="token punctuation">.</span>Author<span class="token operator">></span> <span class="token function">addAuthor</span><span class="token punctuation">(</span>AuthorProto<span class="token punctuation">.</span>AddAuthorRequest request<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> authorServiceFutureStub<span class="token punctuation">.</span><span class="token function">addAuthor</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> ListenableFuture<span class="token operator">&lt;</span>AuthorProto<span class="token punctuation">.</span>Author<span class="token operator">></span> <span class="token function">getAuthor</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> authorServiceFutureStub<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span>AuthorProto<span class="token punctuation">.</span>GetAuthorRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="new-feature"><a href="#new-feature" class="headerlink" title="new feature"></a>new feature</h3><p><a href="https://developers.google.com/protocol-buffers/docs/proto3" target="_blank" rel="noopener">proto3</a>åŸç”Ÿæ˜¯ä¸æ”¯æŒæ•°æ®éªŒè¯çš„ï¼Œå¯èƒ½æˆ‘ä»¬å°±è¦æ‰‹å†™ä»£ç ä¸€ä¸ªå­—æ®µä¸€ä¸ªå­—æ®µå»åšæ ¡éªŒï¼Œé¡¹ç›®ä¸­å°±ä¼šå‡ºç°å¤§é‡çš„ä¸‘é™‹åˆ°çˆ†ç‚¸çš„ä»£ç ã€‚è¿™é‡Œæˆ‘æ‰¾åˆ°ä¸€ä¸ªprotocçš„<a href="https://github.com/envoyproxy/protoc-gen-validate" target="_blank" rel="noopener">validate plugin</a>ï¼Œç›®å‰æ”¯æŒ</p><ul><li>go</li><li>gogo </li><li>cc for c++</li><li>java</li></ul><p>ä»¥ç›®å‰æƒ…å†µæ¥è®²ï¼Œä¸éœ€è¦å¤šè¯­è¨€è°ƒç”¨ï¼Œå³ä½¿å‡ºç°å¤šè¯­è¨€è°ƒç”¨çš„æƒ…å†µä¹Ÿå¯ä»¥ï¼Œä¸å½±å“æ­£å¸¸è°ƒç”¨ï¼Œåªæ˜¯ç¼ºå°‘éªŒè¯è€Œå·²ï¼Œå†ä¸æµä¹Ÿå¯ä»¥è‡ªå·±å®ç°å˜›ï¼</p><h4 id="ä¿®æ”¹proto"><a href="#ä¿®æ”¹proto" class="headerlink" title="ä¿®æ”¹proto"></a>ä¿®æ”¹proto</h4><pre class=" language-proto"><code class="language-proto">import "validate/validate.proto";message AddAuthorRequest{    string name = 1 [(validate.rules).string = {min_len: 5, max_len: 10}];}</code></pre><h4 id="ä¿®æ”¹build-gradle"><a href="#ä¿®æ”¹build-gradle" class="headerlink" title="ä¿®æ”¹build.gradle"></a>ä¿®æ”¹build.gradle</h4><h5 id="æ·»åŠ å¿…è¦ä¾èµ–"><a href="#æ·»åŠ å¿…è¦ä¾èµ–" class="headerlink" title="æ·»åŠ å¿…è¦ä¾èµ–"></a>æ·»åŠ å¿…è¦ä¾èµ–</h5><pre class=" language-gradle"><code class="language-gradle">compile "io.envoyproxy.protoc-gen-validate:pgv-java-stub:${pgvVersion}"compile "io.envoyproxy.protoc-gen-validate:pgv-java-grpc:${pgvVersion}"</code></pre><h5 id="ä¿®æ”¹ç¼–è¯‘é…ç½®"><a href="#ä¿®æ”¹ç¼–è¯‘é…ç½®" class="headerlink" title="ä¿®æ”¹ç¼–è¯‘é…ç½®"></a>ä¿®æ”¹ç¼–è¯‘é…ç½®</h5><pre class=" language-gradle"><code class="language-gradle">protobuf {    // Configure the protoc executable    protoc {        artifact = "com.google.protobuf:protoc:${protocVersion}"    }    plugins {        grpc {            artifact = "io.grpc:protoc-gen-grpc-java:${grpcVersion}"        }        javapgv {            artifact = "io.envoyproxy.protoc-gen-validate:protoc-gen-validate:${pgvVersion}"        }    }    generateProtoTasks {        all()*.plugins {            javapgv {                option "lang=java"            }            grpc {}        }    }}</code></pre><h4 id="æ·»åŠ å®¢æˆ·ç«¯ValidatingClientInterceptor"><a href="#æ·»åŠ å®¢æˆ·ç«¯ValidatingClientInterceptor" class="headerlink" title="æ·»åŠ å®¢æˆ·ç«¯ValidatingClientInterceptor"></a>æ·»åŠ å®¢æˆ·ç«¯ValidatingClientInterceptor</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalClientInterceptorConfiguration</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> GlobalClientInterceptorConfigurer <span class="token function">globalInterceptorConfigurerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ValidatorIndex index <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveValidatorIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> registry <span class="token operator">-</span><span class="token operator">></span> registry            <span class="token punctuation">.</span><span class="token function">addClientInterceptors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogGrpcInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">addClientInterceptors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidatingClientInterceptor</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="æœåŠ¡ç«¯æ·»åŠ ValidatingServerInterceptor"><a href="#æœåŠ¡ç«¯æ·»åŠ ValidatingServerInterceptor" class="headerlink" title="æœåŠ¡ç«¯æ·»åŠ ValidatingServerInterceptor"></a>æœåŠ¡ç«¯æ·»åŠ ValidatingServerInterceptor</h4><pre><code>@Configurationpublic class GlobalServerInterceptorConfiguration {    @Bean    public GlobalServerInterceptorConfigurer globalInterceptorConfigurerAdapter() {        ValidatorIndex index = new ReflectiveValidatorIndex();        return registry -&gt; registry.addServerInterceptors(new ValidatingServerInterceptor(index));    }}</code></pre><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>æµè§ˆå™¨æ‰“å¼€ideaæœ¬åœ°<a href="http://localhost:8888/playground" target="_blank" rel="noopener">http://localhost:8888/playground</a><br><br>æµè§ˆå™¨æ‰“å¼€dockeræœ¬åœ°<a href="http://localhost:8800/playground" target="_blank" rel="noopener">http://localhost:8800/playground</a></p><pre><code>mutation {  addAuthor(request: { name: "" }) {    id    name  }}</code></pre><p>å› ä¸ºåå­—éªŒè¯è§„åˆ™ä¸ºé•¿åº¦5~10ï¼Œè¿™é‡Œnameå€¼ä¸ºç©ºï¼Œæ‰§è¡Œè¿”å›ç»“æœ</p><pre><code>{  "errors": [    {      "message": "INVALID_ARGUMENT: .sample.author.AddAuthorRequest.name: length must be 5 but got: 0 - Got \"\""    }  ],  "extensions": {},  "data": {    "addAuthor": null  }}</code></pre><p>ç”Ÿæ•ˆï¼Œå•¦å•¦å•¦ï¼</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ä»‹ç»graphqlä¸gprcé›†æˆçš„ä¸€äº›é—®é¢˜ï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ–åšåˆ°é«˜æ•ˆèˆ’é€‚çš„ç¼–å†™ä»£ç ã€‚</p><p>æœ¬æ–‡ä»£ç ä»“åº“åœ°å€:<a href="https://github.com/silencecorner/graphql-grpc-exmaple" target="_blank" rel="noopener">https://github.com/silencecorner/graphql-grpc-exmaple</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> grpc </tag>
            
            <tag> graphql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxéƒ¨ç½²é™æ€vueé¡¹ç›®æ—¶çš„æ³¨æ„äº‹é¡¹</title>
      <link href="2019/08/17/nginx-bu-shu-jing-tai-vue-xiang-mu-shi-de-zhu-yi-shi-xiang/"/>
      <url>2019/08/17/nginx-bu-shu-jing-tai-vue-xiang-mu-shi-de-zhu-yi-shi-xiang/</url>
      
        <content type="html"><![CDATA[<img src="/gallery/thumbnails/vue-nginx.png" title="vue-nginx"><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>åœ¨ä½¿ç”¨webpackæˆ–è€…vuecli3ä½œä¸ºè„šæ‰‹æ¶å¼€å‘vueé¡¹ç›®æ—¶ï¼Œä½¿ç”¨å†…ç½®çš„expressç¼–å†™æµ‹è¯•ä»£ç éƒ½æ²¡æœ‰é—®é¢˜ï¼Œè¿ç»´æ‹¿åˆ°buildç”Ÿæˆçš„distæ–‡ä»¶ä¹‹åï¼Œéœ€è¦é€šè¿‡è¿™æ ·æ–¹å¼è®¿é—®<code>http:/xxxx.com/content-path</code>ã€‚å¦‚ä½•éƒ¨ç½²æ‰èƒ½ä¿è¯å‰ç«¯é¡µé¢èµ„æºæ­£ç¡®åŠ è½½å‘¢ï¼Ÿ</p><a id="more"></a><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><h3 id="rootéƒ¨ç½²"><a href="#rootéƒ¨ç½²" class="headerlink" title="rootéƒ¨ç½²"></a>rootéƒ¨ç½²</h3><p>å‡è®¾content-path=<code>post</code>ï¼Œè¿ç»´åŒå­¦è¦rename <code>dist</code>æ–‡ä»¶å¤¹ä¸º<code>post</code>ï¼Œä¸Šçº§æ–‡ä»¶ç›®å½•<code>C:\Users\silencecorner\Project\graphql-grpc-exmaple\vue-apollo-sample</code></p><pre class=" language-bash"><code class="language-bash"><span class="token function">mv</span> dist post</code></pre><p>é…ç½®nginx.confåº”è¯¥å¦‚ä¸‹</p><pre class=" language-conf"><code class="language-conf">location / {    root   C:\Users\silencecorner\Project\graphql-grpc-exmaple\vue-apollo-sample;    index  index.html index.htm;}</code></pre><p>æˆåŠŸè®¿é—®åˆ°<code>http://localhost/post/</code></p><img src="/2019/08/17/nginx-bu-shu-jing-tai-vue-xiang-mu-shi-de-zhu-yi-shi-xiang/æµ‹è¯•.png" title="æµ‹è¯•ç»“æœ"><h3 id="aliaséƒ¨ç½²"><a href="#aliaséƒ¨ç½²" class="headerlink" title="aliaséƒ¨ç½²"></a>aliaséƒ¨ç½²</h3><p>ä»¥rootéƒ¨ç½²ä¾‹å­ä¸ºå‰æ,é‚£ä¹ˆæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶nginx.confåº”è¯¥å¦‚ä¸‹</p><pre class=" language-conf"><code class="language-conf">location /post {    alias   C:\Users\silencecorner\Project\graphql-grpc-exmaple\vue-apollo-sample\dist;    index  index.html index.htm;}</code></pre><p>è®°å¾—æ‰§è¡Œä¸€ä¸‹<code>.\nginx.exe -s reload</code>,è¿™æ˜¯è®¿é—®æˆ‘ä»¬çš„<code>http://localhost/post/</code></p><hr><img src="/2019/08/17/nginx-bu-shu-jing-tai-vue-xiang-mu-shi-de-zhu-yi-shi-xiang/aliasæµ‹è¯•1.png" title="aliasæµ‹è¯•1ç»“æœ"><p>å¦‚å›¾è®¿é—®cssèµ„æº<code>http://localhost/css/app.e2707afb.css</code> 404å•¦ï¼Œæˆ‘ä»¬æ€æ ·å»ç»™è¿™ä¸ªè¿æ¥ä¸‹åŠ ä¸ª<code>post</code>å‘¢ï¼Ÿä»¥vuecli3ä¸ºä¾‹,ä¿®æ”¹<code>vue-config.js</code>æ·»åŠ <code>publicPath</code>æŒ‡å®šå€¼ä¸º<code>post</code></p><pre><code>console.log(`å½“å‰graphqlç½‘å…³è®¿é—®åœ°å€:${process.env.VUE_APP_GRAPHQL_HTTP}`)module.exports = {    publicPath: 'post',    pluginOptions: {        graphqlMock: false,        apolloEngine: false,    },    devServer: {        port: 8081,    }}</code></pre><p>æ­¤æ—¶é‡æ–°æ‰“åŒ…å†æ¬¡è®¿é—®å°±èƒ½æ­£å¸¸è®¿é—®å•¦ï¼</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™é‡Œæœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œè¿ç»´ä¸Šæ¥è®²æ›´å€¾å‘äºç¬¬äºŒç§ï¼Œå‰ç«¯å¯ä»¥é…ç½®ä½¿ç”¨<code>process.env.XXX</code>å˜æ¥è·å–æ§åˆ¶å°å˜é‡ï¼Œè¿ç»´æ‰“åŒ…æ—¶æƒ³éƒ¨ç½²åˆ°ä»»ä½•è·¯å¾„éƒ½å¯ä»¥å•¦ï¼å½“ç„¶ä½¿ç”¨rootæ–¹å¼ä¹Ÿæ˜¯èƒ½è¾¾åˆ°æ•ˆæœï¼Œä½†æ˜¯å¯èƒ½ä¼šç»™è¿ç»´åŒå­¦é€ æˆå›°æ‰°ï¼Œé‡åˆ°è¿™ä¸ªé—®é¢˜çš„å‰ç«¯åŒå­¦å°±ä¸è¦è¯´åœ¨æœ¬åœ°æˆ‘ä»¬ç”¨<code>devServer</code>è·‘éƒ½æ²¡é—®é¢˜çš„è¿™ç§è¯å•¦! </p><hr><p>have a nice day ^_^</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
          <category> è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centeros dockerå®‰è£…åŠç®€å•åº”ç”¨</title>
      <link href="2019/08/16/centeros-docker-an-zhuang-ji-jian-dan-ying-yong/"/>
      <url>2019/08/16/centeros-docker-an-zhuang-ji-jian-dan-ying-yong/</url>
      
        <content type="html"><![CDATA[<h4 id="dockerå®‰è£"><a href="#dockerå®‰è£" class="headerlink" title="dockerå®‰è£"></a>dockerå®‰è£</h4><a id="more"></a><h5 id="å¸è½½"><a href="#å¸è½½" class="headerlink" title="å¸è½½"></a>å¸è½½</h5><pre><code>sudo yum remove docker \                  docker-client \                  docker-client-latest \                  docker-common \                  docker-latest \                  docker-latest-logrotate \                  docker-logrotate \                  docker-selinux \                  docker-engine-selinux \                  docker-engine</code></pre><h5 id="å®‰è£"><a href="#å®‰è£" class="headerlink" title="å®‰è£"></a>å®‰è£</h5><p>é»˜è®¤å®‰è£…stableç‰ˆçš„ï¼Œå®‰è£…edgeæˆ–è€…testç‰ˆæœ¬çš„è¯·è‡ªè¡ŒæŸ¥é˜…<a href="https://docs.docker.com/install/linux/docker-ce/centos/#install-docker-ce-1" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><pre><code>#å®‰è£…é…ç½®ç®¡ç†å·¥å…·sudo yum install -y yum-utils \  device-mapper-persistent-data \  lvm2 sudo yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repo sudo yum install -y docker-ce</code></pre><h5 id="å®‰è£…æŒ‡å®šç‰ˆæœ¬"><a href="#å®‰è£…æŒ‡å®šç‰ˆæœ¬" class="headerlink" title="å®‰è£…æŒ‡å®šç‰ˆæœ¬"></a>å®‰è£…æŒ‡å®šç‰ˆæœ¬</h5><pre><code>yum install https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-selinux-17.03.0.ce-1.el7.centos.noarch.rpmyum install -y docker-ce-17.03.0.ce-1.el7.centos.x86_64</code></pre><h5 id="docker-åŠ é€Ÿé…ç½®ï¼ˆcentos7"><a href="#docker-åŠ é€Ÿé…ç½®ï¼ˆcentos7" class="headerlink" title="docker åŠ é€Ÿé…ç½®ï¼ˆcentos7)"></a>docker åŠ é€Ÿé…ç½®ï¼ˆcentos7)</h5><pre><code>sudo mkdir -p /etc/dockersudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'{  "registry-mirrors": ["https://id7d29lp.mirror.aliyuncs.com"],  "insecure-registries": ["192.168.1.38:5000"]}EOFsudo systemctl daemon-reloadsudo systemctl restart docker</code></pre><h6 id="é…ç½®érootç”¨æˆ·ä½¿ç”¨docker"><a href="#é…ç½®érootç”¨æˆ·ä½¿ç”¨docker" class="headerlink" title="é…ç½®érootç”¨æˆ·ä½¿ç”¨docker"></a>é…ç½®érootç”¨æˆ·ä½¿ç”¨docker</h6><pre><code>#bamboo æ›¿æ¢æˆä½ çš„ç”¨æˆ·åsudo setfacl -m user:bamboo:rw /var/run/docker.sock#è¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯åœ¨åŠ å…¥dockerçš„group</code></pre><h5 id="login"><a href="#login" class="headerlink" title="login"></a>login</h5><pre class=" language-bash"><code class="language-bash">docker login<span class="token comment" spellcheck="true">#ä½ çš„docker hubçš„ç”¨æˆ·åå¯†ç </span></code></pre><p>ç”¨æˆ·åä¸ºå‚æ•°ç™»å½•</p><pre class=" language-bash"><code class="language-bash">docker login --username<span class="token operator">=</span>gedit registry.cn-hangzhou.aliyuncs.com<span class="token comment" spellcheck="true"># ä½ çš„ali dockerhubçš„å¯†ç </span></code></pre><h4 id="docker-machine"><a href="#docker-machine" class="headerlink" title="docker machine"></a>docker machine</h4><pre><code>docker-machine create -d generic --generic-ip-address=192.168.1.67 --generic-ssh-user=administrator host67</code></pre><h4 id="swarmé›†ç¾¤"><a href="#swarmé›†ç¾¤" class="headerlink" title="swarmé›†ç¾¤"></a>swarmé›†ç¾¤</h4><h5 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><pre><code>sudo tee /etc/sysconfig/docker &lt;&lt;-'EOF'OPTIONS='-g /cutome-path/docker -H tcp://0.0.0.0:2375'EOF</code></pre><h5 id="å®‰è£…swarm"><a href="#å®‰è£…swarm" class="headerlink" title="å®‰è£…swarm"></a>å®‰è£…swarm</h5><pre><code>docker pull swarm</code></pre><h5 id="ç”Ÿæˆtoken"><a href="#ç”Ÿæˆtoken" class="headerlink" title="ç”Ÿæˆtoken"></a>ç”Ÿæˆtoken</h5><pre><code>docker -H 192.168.1.38:8888 ps -a</code></pre><h5 id="è®¾ç½®ç®¡ç†èŠ‚ç‚¹"><a href="#è®¾ç½®ç®¡ç†èŠ‚ç‚¹" class="headerlink" title="è®¾ç½®ç®¡ç†èŠ‚ç‚¹"></a>è®¾ç½®ç®¡ç†èŠ‚ç‚¹</h5><p>åœ¨èŠ‚ç‚¹é‡Œé¢ç®¡ç†è®¾ç½®</p><pre><code> docker swarm init --advertise-addr 192.168.1.38</code></pre><h5 id="åŠ å…¥é›†ç¾¤"><a href="#åŠ å…¥é›†ç¾¤" class="headerlink" title="åŠ å…¥é›†ç¾¤"></a>åŠ å…¥é›†ç¾¤</h5><pre><code>docker swarm join \    --token SWMTKN-1-2hjlzufhptigxwvclhbn2b96rvn2ndl8wy8dqzn8otvjcibydp-7hppr5l9agyyp41wght5gpeo6 \    192.168.1.41:2377</code></pre><h5 id="æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹"><a href="#æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹"></a>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</h5><pre><code>docker node ls</code></pre><h5 id="æ‰§è¡Œå‘½ä»¤"><a href="#æ‰§è¡Œå‘½ä»¤" class="headerlink" title="æ‰§è¡Œå‘½ä»¤"></a>æ‰§è¡Œå‘½ä»¤</h5><pre><code>docker service create --name guoi-micro-shopie-shop -p 9039:9002 -p 8940:8902 --env JAVA_OPTS="-Xmx512m" guoi/guoi-micro-shopie-shop --constraint 'node.hostname==istio-master'</code></pre><h4 id="é…ç½®æœ¬åœ°ä»“åº“"><a href="#é…ç½®æœ¬åœ°ä»“åº“" class="headerlink" title="é…ç½®æœ¬åœ°ä»“åº“"></a>é…ç½®æœ¬åœ°ä»“åº“</h4><p><a href="https://blog.csdn.net/ronnyjiang/article/details/71189392" target="_blank" rel="noopener">åŸæ–‡é“¾æ¥</a></p><pre><code>docker run -d -p 5000:5000 -v /home/docker_registry:/var/lib/registry --restart=always --name registry registry:latest  </code></pre><pre><code># insecure-registriesè®¾ç½®æœ¬åœ°ä»“åº“ä½ç½®cat /etc/docker/daemon.json {  "registry-mirrors": ["https://7xwv2psl.mirror.aliyuncs.com"],  "insecure-registries": ["192.168.1.250:5000"]}</code></pre><p>æŸ¥çœ‹ä»“åº“ä½ç½®</p><pre><code>curl -XGET http://192.168.1.250:5000/v2/_catalogcurl -XGET http://192.168.1.250:5000/v2/guoi/guoi-micro-shopie-catalog/tags/list</code></pre><h4 id="jenkins-jarè¿è¡Œ"><a href="#jenkins-jarè¿è¡Œ" class="headerlink" title="jenkins jarè¿è¡Œ"></a>jenkins jarè¿è¡Œ</h4><pre><code>cd github/gedit_cloud_user_test/pid=`ps -ef | grep gedit-cloud-user-0.0.1-SNAPSHOT.jar | grep -v grep | awk '{print $2}'`if [ -n "$pid" ]then#!kill -9 å¼ºåˆ¶ç»ˆæ­¢   echo "kill -9 çš„pid:" $pid   kill -9 $pidfilsgradle build -x test -x dockerBUILD_ID=DONTKILLME #jenkinsç¯å¢ƒå˜é‡nohup java -Dspring.profiles.active=test -jar -Xmx500m build/libs/gedit-cloud-user-0.0.1-SNAPSHOT.jar &gt;&gt;/root/log/gedit_user/user.log 2&gt;&amp;1&amp;</code></pre><h4 id="docker-mysql"><a href="#docker-mysql" class="headerlink" title="docker mysql"></a>docker mysql</h4><pre><code>#dump datamysql -uroot gedit_store&gt;sqlbackup/gedit_store.docker.sqlmysql -uroot gedit_user&gt;sqlbackup/gedit_user.docker.sql#close mysqlsystemctl mysqld stop#install docker mysqldocker pull mysql #run instancedocker run -itd -p 3306:3306 mysql bash#login ttycontainer=$(docker ps|grep mysql|awk '{print $1}')docker exec -it $container bash#create databasesmysql -urootcreate database gedit_store character set utf8mb4;create database gedit_user character set utf8mb4;exit#exit ttyexit#get mysql ipmysqlIp=$(docker ps|grep mysql|awk '{print $1}'|xargs docker inspect| grep IPAddress|sed -n '2p'|awk '{print $2}'|sed -e 's/\"//g'|sed -e 's/\,//g')echo "mysql ip:$mysqlIp"#backup data,need dump mysql datamysql -uroot -h$mysqlIp gedit_store&lt;sqlbackup/gedit_store.docker.sqlmysql -uroot -h$mysqlIp gedit_user&lt;sqlbackup/gedit_user.docker.sql</code></pre><h5 id="åˆ é™¤noneé•œåƒ"><a href="#åˆ é™¤noneé•œåƒ" class="headerlink" title="åˆ é™¤noneé•œåƒ"></a>åˆ é™¤noneé•œåƒ</h5><pre><code>#delete none imagesdocker rmi -f $(docker images | grep '^&lt;none&gt;' | awk '{print $3}')</code></pre><h5 id="jenkins-docker"><a href="#jenkins-docker" class="headerlink" title="jenkins docker"></a>jenkins docker</h5><pre><code>BUILD_ID=DONTKILLMEgradle build -x test --refresh-dependenciessed 's/-Dspring.profiles.active=test/-Dspring.profiles.active=test/g' DockerfilecontainerId=$(docker ps -a|grep 'conanchen/gedit-cloud-storesearch'|awk '{print $1}')if [ $containerId ]then    echo "stop container id $containerId"    upContainerId=$(docker ps -a|grep 'conanchen/gedit-cloud-storesearch'|grep 'Up'|awk '{print $1}')    if [ $upContainerId ]    then         docker kill $upContainerId    fi    docker rm -f $containerId    docker rmi -f $(docker images|grep 'conanchen/gedit-cloud-storesearch'|awk '{print $3}')figradle build docker -x test -x dockerPushdocker run --name gedit_storesearch -d -p 9091:9090 -p 9985:9985 --env JAVA_OPTS="-Xmx512m" conanchen/gedit-cloud-storesearchsleep 30docker ps -a|grep 'conanchen/gedit-cloud-storesearch'|awk '{print $1}'|xargs docker logs</code></pre><h5 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h5><pre><code>docker pull docker.elastic.co/elasticsearch/elasticsearch:6.1.1docker run -d -it -p 19200:9200 -p 19300:9300 -e "discovery.type=single-node" -e ES_JAVA_OPTS="-Xms256m -Xmx512m" docker.elastic.co/elasticsearch/elasticsearch:6.1.1</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
          <category> CI/CD </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
