<!DOCTYPE HTML><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="Cache-Control" content="no-transform"><meta name="renderer" content="webkit|ie-comp|ie-stand"><meta name="apple-mobile-web-app-capable" content="一个闷骚的博客"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="browsermode" content="application"><meta name="screen-orientation" content="portrait"><meta name="theme-version" content="1.2.3"><meta name="root" content="/"><link rel="dns-prefetch" href="https://silencecorner.github.io"><meta name="keywords" content="grpc,graphql"><meta name="description" content="
前言graphql和grpc的protobuf的schema都是一个描述性文件，只是双方的具体作用有差别而已。在Java中使用schema first的graphql-java-tools无疑..."><meta name="robots" content="all"><meta name="google" content="all"><meta name="googlebot" content="all"><meta name="verify" content="all"><title>graphql与grpc集成 | 一个闷骚的博客</title><link rel="alternate" href="/atom.xml" title="一个闷骚的博客" type="application/atom+xml"><link rel="icon" href="/favicon-32x32.ico"><link rel="stylesheet" href="/css/bootstrap.min.css?rev=d73d2314ac7cf1291564a5c92adc5030"><link rel="stylesheet" href="/css/font-awesome.min.css?rev=2f79304e4f79fcb5c09284e38c9123e9"><link rel="stylesheet" href="/css/style.css?rev=24fb40f2d792a28d9d73eaa5f205db18"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a5f9f1e2d8963b5a57b96bcf6b4891f1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><!--[if lte IE 8]><style>
    html{ font-size: 1em }
</style><![endif]--><!--[if lte IE 9]><div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div><![endif]--><body><header class="main-header" style="background-image:url(http://snippet.shenliyang.com/img/banner.jpg)"><div class="main-header-box"><a class="header-avatar" href="/" title="silence角落"><img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block"></a><div class="branding"><h2 class="text-hide">Snippet主题,从未如此简单有趣</h2><h2>快乐学习轻松工作</h2></div></div></header><nav class="main-navigation"><div class="container"><div class="row"><div class="col-sm-12"><div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav"><span class="sr-only"></span><i class="fa fa-bars"></i></span> <a class="navbar-brand" href="https://silencecorner.github.io">一个闷骚的博客</a></div><div class="collapse navbar-collapse" id="main-menu"><ul class="menu"><li role="presentation" class="text-center"><a href="/"><i class="fa"></i> 首页</a></li><li role="presentation" class="text-center"><a href="/categories"><i class="fa"></i> 分类</a></li><li role="presentation" class="text-center"><a href="/categories/java/"><i class="fa"></i> java</a></li><li role="presentation" class="text-center"><a href="/archives/"><i class="fa"></i> 时间轴</a></li><li role="presentation" class="text-center"><a href="/about/"><i class="fa"></i> 关于我</a></li></ul></div></div></div></div></nav><section class="content-wrap"><div class="container"><div class="row"><main class="col-md-8 main-content m-post"><p id="process"></p><article class="post"><div class="post-head"><h1 id="graphql与grpc集成">graphql与grpc集成</h1><div class="post-meta"><span class="categories-meta fa-wrap"><i class="fa fa-folder-open-o"></i> <a class="category-link" href="/categories/java/">java</a></span><span class="fa-wrap"><i class="fa fa-tags"></i> <span class="tags-meta"><a class="tag-link" href="/tags/graphql/">graphql</a> <a class="tag-link" href="/tags/grpc/">grpc</a></span></span><span class="fa-wrap"><i class="fa fa-clock-o"></i> <span class="date-meta">2019/08/18</span></span><span class="fa-wrap"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="post-body post-content"><img src="/gallery/thumbnails/1_o9_bjlKXlMjii3G7BCNb-Q.png" title="架构图"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>graphql和grpc的protobuf的schema都是一个描述性文件，只是双方的具体作用有差别而已。在Java中使用schema first的<code>graphql-java-tools</code>无疑是graphql在java语言的最佳入门实践，那么问题就来啦！protobuf和graphql各自都有自己的类型系统，graphql因为会序列化为json，那么就要遵从java bean的规范（序列化框架要求），protobuf使用的builder构造对象，没有默认的构造方法。<a id="more"></a><br><br>本文代码仓库地址:<a href="https://github.com/silencecorner/graphql-grpc-exmaple" target="_blank" rel="noopener">https://github.com/silencecorner/graphql-grpc-exmaple</a>，如果了解<a href="https://github.com/graphql-java-kickstart" target="_blank" rel="noopener">graphql-java-kickstart</a>的代码的话，可以直接查看源代码！</p><ul><li><code>graphql-api</code> nodejs实现的网关</li><li><code>graphql-gateway-java</code> java实现的网关</li><li><code>post-api-java</code> post服务端微服务程序</li><li><code>protos</code> proto源文件</li><li><code>schema</code> graphql文件目录</li><li><code>vue-apollo-sample</code> 基于graphql规范的vue项目<h3 id="优化思路"><a href="#优化思路" class="headerlink" title="优化思路"></a>优化思路</h3><h4 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h4>因为在去年实践过一次，没有深入思考，写起来总感觉有一点别扭！所以最开始我的想法是改用nodejs来写去掉类型检查，也写过一个在<a href="https://github.com/silencecorner/graphql-grpc-exmaple/tree/master/graphql-api" target="_blank" rel="noopener">repo的graphql-api中</a><h4 id="converter"><a href="#converter" class="headerlink" title="converter"></a>converter</h4>nodejs写起来挺简单的，但是java才是主要开发语言，所以又按照去年的那个套路实现了一次，按照converter的思路使用了<a href="https://github.com/BAData/protobuf-converter" target="_blank" rel="noopener">protobuf-converter</a>类库,优化了一下但是还是有一些不适。<h4 id="jackson序列化框架"><a href="#jackson序列化框架" class="headerlink" title="jackson序列化框架"></a>jackson序列化框架</h4>今天我就在想能不能jackson和protobuf之间做桥接一下，google搜索了果然已经有实现的<a href="https://github.com/HubSpot/jackson-datatype-protobuf" target="_blank" rel="noopener">类库</a>，终于不用再写一遍java model啦！<h5 id="删除代码"><a href="#删除代码" class="headerlink" title="删除代码"></a>删除代码</h5>删除之前的inputs、types package，改用protobuf生成的代码，这里桥接要注入<code>ProtobufModule</code>，又想能不能直接使用返回<code>ListenableFuture</code>实例，通过查找资料可以实现。<h5 id="添加GraphqlToolConfiguration-java"><a href="#添加GraphqlToolConfiguration-java" class="headerlink" title="添加GraphqlToolConfiguration.java"></a>添加<code>GraphqlToolConfiguration.java</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class GraphqlToolConfiguration &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	SchemaParserOptions options()&#123;</span><br><span class="line">		ObjectMapper objectMapper = Jackson2ObjectMapperBuilder.json()</span><br><span class="line">			.modules(new ProtobufModule(), new Jdk8Module(), new KotlinModule(), new JavaTimeModule())</span><br><span class="line">			.build();</span><br><span class="line">		return SchemaParserOptions.newOptions()</span><br><span class="line">			.genericWrappers(SchemaParserOptions.GenericWrapper</span><br><span class="line">				.withTransformer(ListenableFuture.class,0,ListenableFuturesExtra::toCompletableFuture, type -&gt; type))</span><br><span class="line">			.objectMapperProvider(fieldDefinition -&gt; objectMapper )</span><br><span class="line">			.useDefaultGenericWrappers(true)</span><br><span class="line">			.build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>这样我们就可以使用protobuf生成的class、grpc直接返回的<code>ListenableFuture</code>，字段对应protobuf的<a href="https://developers.google.com/protocol-buffers/docs/style#message-and-field-names" target="_blank" rel="noopener">JsonName</a>，</p><h5 id="schema-graphql"><a href="#schema-graphql" class="headerlink" title="schema.graphql"></a>schema.graphql</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">scalar DateTime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 作者</span><br><span class="line">type Author&#123;</span><br><span class="line">  # unique id</span><br><span class="line">  id: ID!</span><br><span class="line">  # 名称</span><br><span class="line">  name: String</span><br><span class="line">&#125;</span><br><span class="line"># 添加作者参数</span><br><span class="line">input AddAuthorRequest&#123;</span><br><span class="line">  # 名字</span><br><span class="line">  name: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Post &#123;</span><br><span class="line">  # id</span><br><span class="line">  id: ID</span><br><span class="line">  # 标题</span><br><span class="line">  title: String</span><br><span class="line">  # 内容</span><br><span class="line">  body: String</span><br><span class="line">  # 创建时间</span><br><span class="line">  createdAt: DateTime</span><br><span class="line">  # 文章作者</span><br><span class="line">  author: Author</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 分页返回结果</span><br><span class="line">type Posts &#123;</span><br><span class="line">  # 总数</span><br><span class="line">  count: Int</span><br><span class="line">  # 当前页</span><br><span class="line">  page: Int</span><br><span class="line">  # 条数</span><br><span class="line">  limit: Int</span><br><span class="line">  # 结点</span><br><span class="line">  nodesList: [Post]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加文章参数</span><br><span class="line">input AddPostRequest &#123;</span><br><span class="line">  # 标题</span><br><span class="line">  title: String</span><br><span class="line">  # 内容</span><br><span class="line">  body: String</span><br><span class="line">&#125;</span><br><span class="line"># 分页参数</span><br><span class="line">input ListPostRequest&#123;</span><br><span class="line">    # 第几页</span><br><span class="line">    page: Int!</span><br><span class="line">    # 获取条数</span><br><span class="line">    limit: Int!</span><br><span class="line">&#125;</span><br><span class="line">type Query &#123;</span><br><span class="line">  listPosts(request: ListPostRequest): Posts</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Mutation &#123;</span><br><span class="line">  addPost(request: AddPostRequest): Post</span><br><span class="line">  # 新增作者</span><br><span class="line">  addAuthor(request: AddAuthorRequest!): Author</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">schema &#123;</span><br><span class="line">  query: Query</span><br><span class="line">  mutation: Mutation</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Mutation-java"><a href="#Mutation-java" class="headerlink" title="Mutation.java"></a>Mutation.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mutation</span> <span class="keyword">implements</span> <span class="title">GraphQLMutationResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostClient postClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthorClient authorClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ListenableFuture&lt;PostProto.Post&gt; addPost(PostProto.AddPostRequest request)&#123;</span><br><span class="line">		<span class="keyword">return</span> postClient.addPost(request.toBuilder().setAuthorId(<span class="number">1</span>).build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ListenableFuture&lt;AuthorProto.Author&gt; addAuthor(AuthorProto.AddAuthorRequest request)&#123;</span><br><span class="line">    	  <span class="keyword">return</span> authorClient.addAuthor(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Query-java"><a href="#Query-java" class="headerlink" title="Query.java"></a>Query.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Query</span> <span class="keyword">implements</span> <span class="title">GraphQLQueryResolver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PostClient postClient;</span><br><span class="line">    <span class="keyword">public</span> ListenableFuture&lt;PostProto.Posts&gt; listPosts(PostProto.ListPostRequest request)&#123;</span><br><span class="line">        <span class="keyword">return</span> postClient.listPost(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="PostResolver-java"><a href="#PostResolver-java" class="headerlink" title="PostResolver.java"></a>PostResolver.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostResolver</span> <span class="keyword">implements</span> <span class="title">GraphQLResolver</span>&lt;<span class="title">PostProto</span>.<span class="title">Post</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AuthorClient authorClient;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> ListenableFuture&lt;AuthorProto.Author&gt; author(PostProto.Post post)&#123;</span><br><span class="line">		<span class="keyword">return</span> authorClient.getAuthor(post.getAuthorId());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="PostsResolver-java"><a href="#PostsResolver-java" class="headerlink" title="PostsResolver.java"></a>PostsResolver.java</h5><p>proto定义的是<a href="https://github.com/silencecorner/graphql-grpc-exmaple/blob/master/protos/Post.proto#L26" target="_blank" rel="noopener">nodes</a>字段，生成的java代码的get方法是<code>getNodesList</code>，此时对应的jackson的json字段就变成<code>nodesList</code>，我们的graphql中使用是<code>nodes</code>字段，按照<code>graphql-java-tools</code>的解析顺序</p><ul><li>com.bd.gateway.resolvers.post.PostsResolver.nodes(sample.PostProto$Posts)</li><li>com.bd.gateway.resolvers.post.PostsResolver.getNodes(sample.PostProto$Posts)</li><li>com.bd.gateway.resolvers.post.PostsResolver.nodes</li><li>sample.PostProto$Posts.nodes()</li><li>sample.PostProto$Posts.getNodes()</li><li>sample.PostProto$Posts.nodes</li></ul><p>添加如下代码就可以解决字段不一样的问题啦！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class PostsResolver implements GraphQLResolver&lt;PostProto.Posts&gt; &#123;</span><br><span class="line"></span><br><span class="line">	public List&lt;PostProto.Post&gt; nodes(PostProto.Posts posts)&#123;</span><br><span class="line">		return posts.getNodesList();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="PostClient-java"><a href="#PostClient-java" class="headerlink" title="PostClient.java"></a>PostClient.java</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class PostClient &#123;</span><br><span class="line">    @GrpcClient(&quot;post-grpc-server&quot;)</span><br><span class="line">    private PostServiceGrpc.PostServiceFutureStub postServiceFutureStub;</span><br><span class="line"></span><br><span class="line">    public ListenableFuture&lt;PostProto.Post&gt; addPost(sample.PostProto.AddPostRequest request)&#123;</span><br><span class="line">        return postServiceFutureStub.addPost(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ListenableFuture&lt;PostProto.Posts&gt; listPost(sample.PostProto.ListPostRequest request)&#123;</span><br><span class="line">        return postServiceFutureStub.listPosts(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="AuthorClient-java"><a href="#AuthorClient-java" class="headerlink" title="AuthorClient.java"></a>AuthorClient.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GrpcClient</span>(<span class="string">"author-grpc-server"</span>)</span><br><span class="line">    <span class="keyword">private</span> AuthorServiceGrpc.AuthorServiceFutureStub authorServiceFutureStub;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ListenableFuture&lt;AuthorProto.Author&gt; addAuthor(AuthorProto.AddAuthorRequest request)&#123;</span><br><span class="line">        <span class="keyword">return</span> authorServiceFutureStub.addAuthor(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ListenableFuture&lt;AuthorProto.Author&gt; getAuthor(Integer id)&#123;</span><br><span class="line">        <span class="keyword">return</span> authorServiceFutureStub.getAuthor(AuthorProto.GetAuthorRequest.newBuilder().setId(id).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="protobuf-repeated字段匹配问题"><a href="#protobuf-repeated字段匹配问题" class="headerlink" title="protobuf repeated字段匹配问题"></a>protobuf repeated字段匹配问题</h3><p><a href="https://github.com/silencecorner/graphql-java-tools/commit/659d342281012653126aa1d8d9962af2f348a816" target="_blank" rel="noopener">添加graphql-java-tools List后缀匹配</a>，解决repeated字段桥接转换失败的问题</p><h3 id="new-feature"><a href="#new-feature" class="headerlink" title="new feature"></a>new feature</h3><p><a href="https://developers.google.com/protocol-buffers/docs/proto3" target="_blank" rel="noopener">proto3</a>原生是不支持数据验证的，可能我们就要手写代码一个字段一个字段去做校验，项目中就会出现大量的丑陋到爆炸的代码。这里我找到一个protoc的<a href="https://github.com/envoyproxy/protoc-gen-validate" target="_blank" rel="noopener">validate plugin</a>，目前支持</p><ul><li>go</li><li>gogo</li><li>cc for c++</li><li>java</li></ul><p>以目前情况来讲，不需要多语言调用，即使出现多语言调用的情况也可以，不影响正常调用，只是缺少验证而已，再不济也可以自己实现嘛！</p><h4 id="修改proto"><a href="#修改proto" class="headerlink" title="修改proto"></a>修改proto</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import &quot;validate/validate.proto&quot;;</span><br><span class="line">message AddAuthorRequest&#123;</span><br><span class="line">    string name = 1 [(validate.rules).string = &#123;min_len: 5, max_len: 10&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改build-gradle"><a href="#修改build-gradle" class="headerlink" title="修改build.gradle"></a>修改build.gradle</h4><h5 id="添加必要依赖"><a href="#添加必要依赖" class="headerlink" title="添加必要依赖"></a>添加必要依赖</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">"io.envoyproxy.protoc-gen-validate:pgv-java-stub:$&#123;pgvVersion&#125;"</span></span><br><span class="line"><span class="keyword">compile</span> <span class="string">"io.envoyproxy.protoc-gen-validate:pgv-java-grpc:$&#123;pgvVersion&#125;"</span></span><br></pre></td></tr></table></figure><h5 id="修改编译配置"><a href="#修改编译配置" class="headerlink" title="修改编译配置"></a>修改编译配置</h5><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">protobuf &#123;</span><br><span class="line">    <span class="comment">// Configure the protoc executable</span></span><br><span class="line">    protoc &#123;</span><br><span class="line">        artifact = <span class="string">"com.google.protobuf:protoc:$&#123;protocVersion&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        grpc &#123;</span><br><span class="line">            artifact = <span class="string">"io.grpc:protoc-gen-grpc-java:$&#123;grpcVersion&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">        javapgv &#123;</span><br><span class="line">            artifact = <span class="string">"io.envoyproxy.protoc-gen-validate:protoc-gen-validate:$&#123;pgvVersion&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    generateProtoTasks &#123;</span><br><span class="line">        all()*.plugins &#123;</span><br><span class="line">            javapgv &#123;</span><br><span class="line">                option <span class="string">"lang=java"</span></span><br><span class="line">            &#125;</span><br><span class="line">            grpc &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="添加客户端ValidatingClientInterceptor"><a href="#添加客户端ValidatingClientInterceptor" class="headerlink" title="添加客户端ValidatingClientInterceptor"></a>添加客户端ValidatingClientInterceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalClientInterceptorConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GlobalClientInterceptorConfigurer <span class="title">globalInterceptorConfigurerAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	ValidatorIndex index = <span class="keyword">new</span> ReflectiveValidatorIndex();</span><br><span class="line">        <span class="keyword">return</span> registry -&gt; registry</span><br><span class="line">			.addClientInterceptors(<span class="keyword">new</span> LogGrpcInterceptor())</span><br><span class="line">			.addClientInterceptors(<span class="keyword">new</span> ValidatingClientInterceptor(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="服务端添加ValidatingServerInterceptor"><a href="#服务端添加ValidatingServerInterceptor" class="headerlink" title="服务端添加ValidatingServerInterceptor"></a>服务端添加ValidatingServerInterceptor</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class GlobalServerInterceptorConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public GlobalServerInterceptorConfigurer globalInterceptorConfigurerAdapter() &#123;</span><br><span class="line">		ValidatorIndex index = new ReflectiveValidatorIndex();</span><br><span class="line">        return registry -&gt; registry.addServerInterceptors(new ValidatingServerInterceptor(index));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>浏览器打开idea本地<a href="http://localhost:8888/playground" target="_blank" rel="noopener">http://localhost:8888/playground</a><br><br>浏览器打开docker本地<a href="http://localhost:8800/playground" target="_blank" rel="noopener">http://localhost:8800/playground</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mutation &#123;</span><br><span class="line">  addAuthor(request: &#123; name: &quot;&quot; &#125;) &#123;</span><br><span class="line">    id</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为名字验证规则为长度5~10，这里name值为空，执行返回结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;errors&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;message&quot;: &quot;INVALID_ARGUMENT: .sample.author.AddAuthorRequest.name: length must be 5 but got: 0 - Got \&quot;\&quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;extensions&quot;: &#123;&#125;,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;addAuthor&quot;: null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生效，啦啦啦！</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>介绍graphql与gprc集成的一些问题，以及如何优化做到高效舒适的编写代码。</p><p>本文代码仓库地址:<a href="https://github.com/silencecorner/graphql-grpc-exmaple/tree/0.2.0" target="_blank" rel="noopener">https://github.com/silencecorner/graphql-grpc-exmaple/tree/0.2.0</a></p></div><div class="post-footer"><div>转载声明： 商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">silence角落</a></div><div></div></div></article><div class="article-nav prev-next-wrap clearfix"><a href="/2019/08/19/org-hibernate-LazyInitializationException-could-not-initialize-proxy-xxxx-no/" class="pre-post btn btn-default" title="org.hibernate.LazyInitializationException"><i class="fa fa-angle-left fa-fw"></i> <span class="hidden-lg">上一篇</span> <span class="hidden-xs">org.hibernate.LazyInitializationException</span></a> <a href="/2019/08/17/nginx部署静态vue项目时的注意事项/" class="next-post btn btn-default" title="nginx部署静态vue项目时的注意事项"><span class="hidden-lg">下一篇</span> <span class="hidden-xs">nginx部署静态vue项目时的注意事项</span><i class="fa fa-angle-right fa-fw"></i></a></div><div id="comments"><link rel="stylesheet" href="https://cdn.bootcss.com/gitalk/1.4.1/gitalk.min.css"><script src="//cdn.bootcss.com/gitalk/1.4.1/gitalk.min.js"></script><script src="//cdn.bootcss.com/blueimp-md5/2.9.0/js/md5.min.js"></script><div id="gitalk-container"></div><script type="text/javascript">var gitalk=new Gitalk({language:"zh-CN",clientID:"c11c2cbf3e1c2d0d9f9d",clientSecret:"27face6fb1f58b5ae5984d3d27fec77966d9f794",repo:"silencecorner.github.io",owner:"silencecorner",admin:["silencecorner"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("gitalk-container")</script></div></main><aside id="article-toc" role="navigation" class="col-md-4"><div class="widget"><h3 class="title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化思路"><span class="toc-text">优化思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nodejs"><span class="toc-text">nodejs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#converter"><span class="toc-text">converter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jackson序列化框架"><span class="toc-text">jackson序列化框架</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#删除代码"><span class="toc-text">删除代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加GraphqlToolConfiguration-java"><span class="toc-text">添加GraphqlToolConfiguration.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#schema-graphql"><span class="toc-text">schema.graphql</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Mutation-java"><span class="toc-text">Mutation.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Query-java"><span class="toc-text">Query.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PostResolver-java"><span class="toc-text">PostResolver.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PostsResolver-java"><span class="toc-text">PostsResolver.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PostClient-java"><span class="toc-text">PostClient.java</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AuthorClient-java"><span class="toc-text">AuthorClient.java</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf-repeated字段匹配问题"><span class="toc-text">protobuf repeated字段匹配问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#new-feature"><span class="toc-text">new feature</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改proto"><span class="toc-text">修改proto</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改build-gradle"><span class="toc-text">修改build.gradle</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#添加必要依赖"><span class="toc-text">添加必要依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#修改编译配置"><span class="toc-text">修改编译配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#添加客户端ValidatingClientInterceptor"><span class="toc-text">添加客户端ValidatingClientInterceptor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端添加ValidatingServerInterceptor"><span class="toc-text">服务端添加ValidatingServerInterceptor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></div></aside></div></div></section><footer class="main-footer"><div class="container"><div class="row"></div></div></footer><a id="back-to-top" class="icon-btn hide"><i class="fa fa-chevron-up"></i></a><div class="copyright"><div class="container"><div class="row"><div class="col-sm-12"><div class="busuanzi">访问量:<strong id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></strong> &nbsp; | &nbsp; 访客数:<strong id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></strong></div></div><div class="col-sm-12"><span>Copyright &copy; 2018</span> | <span>Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a></span> | <span>Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a></span></div></div></div></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/app.js?rev=e66bcd843db8808cbec1cc2ec0575f8f"></script></body>